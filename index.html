<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KakaoTalk Clone</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<style>
  /* ===== Reset & Base ===== */
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    background-color: #fff; /* í™ˆ í™”ë©´ì€ í°ìƒ‰ */
    height: 100vh; overflow: hidden;
    font-size: 13px;
    color: #000;
  }

  /* ===== Common Utilities ===== */
  .hidden { display: none !important; }
  .icon { font-family: 'Material Symbols Outlined'; font-size: 22px; user-select: none; }
  .profile-thumb {
    width: 42px; height: 42px; border-radius: 16px;
    background-image: url('https://t1.kakaocdn.net/account_images/default_profile.jpeg.twg.thumb.R640x640');
    background-size: cover; background-blend-mode: multiply;
    background-color: #eee; flex-shrink: 0;
  }

  /* ===== Screen Container ===== */
  #screen-container {
    width: 100%; height: 100%; position: relative;
  }

  /* ===== VIEW 1: HOME (Lobby) ===== */
  #view-home {
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    background: #fff;
  }

  /* Home Header */
  .home-header {
    height: 50px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between;
    font-size: 20px; font-weight: 700;
  }
  .header-icons { display: flex; gap: 16px; }
  .header-icons .icon { cursor: pointer; }

  /* Tab Content Area */
  .tab-content {
    flex: 1; overflow-y: auto; padding-bottom: 60px; /* íƒ­ë°” ê³µê°„ */
  }

  /* Friend/Chat List Item */
  .list-item {
    display: flex; align-items: center; padding: 10px 16px;
    cursor: pointer; transition: background 0.1s;
  }
  .list-item:active { background: #f2f2f2; }
  .list-item .text-area { margin-left: 12px; display: flex; flex-direction: column; justify-content: center; flex: 1; }
  .list-item .name { font-size: 14px; font-weight: 600; margin-bottom: 2px; color: #111; }
  .list-item .desc { font-size: 11px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .list-item .meta { font-size: 10px; color: #bbb; }

  /* Bottom Navigation */
  .bottom-nav {
    height: 56px; border-top: 1px solid #f1f1f1;
    display: flex; align-items: center; justify-content: space-around;
    background: #fff; padding-bottom: env(safe-area-inset-bottom);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #aaa; cursor: pointer; width: 100%; height: 100%;
  }
  .nav-item.active { color: #333; }
  .nav-item .icon { font-size: 24px; margin-bottom: 2px; }

  /* ===== VIEW 2: CHAT ROOM ===== */
  #view-chat {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #b2c7d9; z-index: 200;
    display: flex; flex-direction: column;
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
  }
  #view-chat.open { transform: translateX(0); }

  /* Chat Header */
  .chat-header {
    height: 44px; background: rgba(255,255,255,0.95);
    display: flex; align-items: center; padding: 0 10px;
    border-bottom: 1px solid rgba(0,0,0,0.05); backdrop-filter: blur(5px);
  }
  .chat-header .back-btn { cursor: pointer; padding: 8px; font-size: 20px; color: #333; }
  .chat-header .room-title { flex: 1; font-size: 15px; font-weight: 700; margin-left: 4px; }
  .chat-header .room-meta { font-size: 12px; color: #888; font-weight: 400; margin-left: 4px; }
  
  /* Chat Search Bar (In-Room) */
  #search-area {
    background: #f2f2f2; padding: 8px 10px; display: none; border-bottom: 1px solid #ddd;
  }
  #search-area.active { display: flex; }
  #search-input { width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; outline: none; }

  /* Chat Messages Area */
  #chat-msgs {
    flex: 1; padding: 10px 12px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 10px;
    padding-bottom: 10px;
  }
  #chat-msgs::-webkit-scrollbar { display: none; }

  /* Message Styling (Previous Code Integrated) */
  .msg-row { display: flex; width: 100%; align-items: flex-start; }
  .msg-row.me { justify-content: flex-end; }
  .msg-content { display: flex; flex-direction: column; max-width: 72%; }
  .name { font-size: 11px; color: #555; margin-bottom: 3px; margin-left: 2px; }
  .bubble-wrapper { display: flex; align-items: flex-end; }
  .me .bubble-wrapper { flex-direction: row-reverse; }
  .bubble {
    padding: 8px 12px; font-size: 13px; line-height: 1.4; word-break: break-all;
    border-radius: 16px; box-shadow: 0 1px 1px rgba(0,0,0,0.05);
  }
  .other .bubble { background: #ffffff; border-top-left-radius: 2px; }
  .me .bubble { background: #fef01b; border-top-right-radius: 2px; }
  .info { display: flex; flex-direction: column; justify-content: flex-end; margin: 0 4px; min-width: fit-content; }
  .read-count { font-size: 9px; color: #d6a318; font-weight: bold; text-align: right; margin-bottom: 2px; }
  .me .read-count { text-align: right; }
  .other .read-count { text-align: left; }
  .time { font-size: 9px; color: #555; white-space: nowrap; }
  .highlight { background-color: #ffd700; color: #000; font-weight: bold; }

  /* Chat Input */
  #input-area {
    background: #fff; padding: 8px; display: flex; align-items: center; gap: 8px;
    border-top: 1px solid #ededed; padding-bottom: max(8px, env(safe-area-inset-bottom));
  }
  #msg-input-field {
    flex: 1; height: 34px; background: #f3f3f3; border: none; border-radius: 17px;
    padding: 0 14px; font-size: 13px; outline: none;
  }
  #sendBtn {
    width: 34px; height: 34px; background: #fef01b; border: none; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }

  /* ===== Modals ===== */
  .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999;
    display: none; align-items: center; justify-content: center;
  }
  .modal-content {
    background: #fff; padding: 20px; border-radius: 12px; width: 80%; max-width: 280px; text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  .modal-btn {
    width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 8px;
    font-size: 14px; font-weight: 600; cursor: pointer;
  }
  .bg-yellow { background: #fef01b; color: #3b1e1e; }
  .bg-gray { background: #f2f2f2; color: #333; }

</style>
</head>
<body>

<div id="screen-container">

  <div id="view-home">
    
    <div class="home-header">
      <span id="header-title">ì¹œêµ¬</span>
      <div class="header-icons">
        <span class="icon" onclick="openSearchModal()">search</span>
        <span class="icon" onclick="openCreateChatModal()">add_circle</span> <span class="icon" onclick="openSettings()">settings</span>
      </div>
    </div>

    <div id="tab-friends" class="tab-content">
      <div class="list-item" onclick="enterChat('ë‚˜ì™€ì˜ ì±„íŒ…')">
        <div class="profile-thumb" id="my-profile-img"></div>
        <div class="text-area">
          <div class="name" id="my-name-display">ë‚˜</div>
          <div class="desc">ìƒíƒœë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>
      </div>
      <hr style="border:0; border-top:1px solid #f5f5f5; margin:0;">
      
      <div style="padding:10px 16px; font-size:11px; color:#999;">ì¹œêµ¬ 2</div>
      
      <div class="list-item" onclick="enterChat('ê¹€ì² ìˆ˜')">
        <div class="profile-thumb" style="background-color:#FFB7B2"></div>
        <div class="text-area">
          <div class="name">ê¹€ì² ìˆ˜</div>
          <div class="desc">ì˜¤ëŠ˜ ì ì‹¬ ë­ ë¨¹ì§€?</div>
        </div>
      </div>
      <div class="list-item" onclick="enterChat('ì´ì˜í¬')">
        <div class="profile-thumb" style="background-color:#B5EAD7"></div>
        <div class="text-area">
          <div class="name">ì´ì˜í¬</div>
          <div class="desc">íœ´ê°€ ì¤‘ âœˆï¸</div>
        </div>
      </div>
    </div>

    <div id="tab-chats" class="tab-content hidden">
      <div class="list-item" onclick="enterChat('ì˜¤í”ˆì±„íŒ…ë°©')">
        <div class="profile-thumb" style="border-radius:14px; background:#ddd; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ’¬</div>
        <div class="text-area">
          <div class="name">ì˜¤í”ˆì±„íŒ…ë°©</div>
          <div class="desc" style="color:#666;">ì§€ê¸ˆ ëŒ€í™”ì— ì°¸ì—¬í•´ë³´ì„¸ìš”!</div>
        </div>
        <div class="meta">ë°©ê¸ˆ</div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('friends', this)">
        <span class="icon">person</span>
      </div>
      <div class="nav-item" onclick="switchTab('chats', this)">
        <span class="icon">chat_bubble</span>
      </div>
      <div class="nav-item" onclick="alert('ë”ë³´ê¸° ê¸°ëŠ¥ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.')">
        <span class="icon">more_horiz</span>
      </div>
    </div>
  </div>


  <div id="view-chat">
    <header class="chat-header">
      <span class="icon back-btn" onclick="exitChat()">arrow_back</span>
      <div class="room-title" id="current-room-name">ì˜¤í”ˆì±„íŒ…ë°©</div>
      <span class="room-meta">4</span>
      <div style="flex:1;"></div>
      <span class="icon" onclick="toggleInChatSearch()" style="font-size:20px; color:#333;">search</span>
    </header>

    <div id="search-area">
      <input id="search-input" placeholder="ëŒ€í™” ë‚´ìš© ê²€ìƒ‰..." oninput="onSearch(this.value)">
    </div>

    <div id="chat-msgs"></div>

    <div id="input-area">
      <span class="icon" style="color:#bbb; margin-right:4px;">add</span>
      <input id="msg-input-field" placeholder="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off">
      <button id="sendBtn" onclick="sendMsg()">
        <span class="material-symbols-outlined" style="font-size:18px; font-weight:600;">arrow_upward</span>
      </button>
    </div>
  </div>

</div>

<div id="nickModal" class="modal" style="display: flex;">
  <div class="modal-content">
    <h3>ì‹œì‘í•˜ê¸°</h3>
    <input id="nicknameInput" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
    <button class="modal-btn bg-yellow" onclick="saveNickname()">í™•ì¸</button>
  </div>
</div>

<div id="createChatModal" class="modal">
  <div class="modal-content">
    <h3>ìƒˆë¡œìš´ ì±„íŒ…</h3>
    <button class="modal-btn bg-yellow" onclick="createNewChat('1:1 ì±„íŒ…')">1:1 ì±„íŒ…</button>
    <button class="modal-btn bg-yellow" onclick="createNewChat('ê·¸ë£¹ ì±„íŒ…')">ê·¸ë£¹ ì±„íŒ…</button>
    <button class="modal-btn bg-yellow" onclick="createNewChat('ì˜¤í”ˆ ì±„íŒ…')">ì˜¤í”ˆ ì±„íŒ…</button>
    <button class="modal-btn bg-gray" onclick="closeModal('createChatModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h3>ì„¤ì •</h3>
    <p style="color:#666; font-size:12px; margin-bottom:15px;">ì•± ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
    <button class="modal-btn" style="background:#ff4d4d; color:white;" onclick="resetApp()">ì´ˆê¸°í™” (ë¡œê·¸ì•„ì›ƒ)</button>
    <button class="modal-btn bg-gray" onclick="closeModal('settingsModal')">ë‹«ê¸°</button>
  </div>
</div>

<script>
  /* ===== Global State ===== */
  const API_URL = "https://jaewondev3.pythonanywhere.com";
  let myName = localStorage.getItem("nickname");
  let allMessages = [];
  let searchKeyword = "";
  let isChatOpen = false; // í˜„ì¬ ì±„íŒ…ë°©ì— ë“¤ì–´ì™”ëŠ”ì§€ ì—¬ë¶€

  /* íŒŒìŠ¤í…” ì»¬ëŸ¬ */
  const pastelColors = ["#FFB7B2", "#FFDAC1", "#E2F0CB", "#B5EAD7", "#C7CEEA", "#e4c1f9", "#ffadad"];
  function getColorFromName(name) {
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash += name.charCodeAt(i);
    return pastelColors[hash % pastelColors.length];
  }

  /* ===== Init ===== */
  if (myName) {
    document.getElementById("nickModal").style.display = "none";
    initHome();
  }

  function saveNickname() {
    const val = document.getElementById("nicknameInput").value.trim();
    if (!val) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”");
    myName = val;
    localStorage.setItem("nickname", myName);
    document.getElementById("nickModal").style.display = "none";
    initHome();
  }

  function initHome() {
    document.getElementById("my-name-display").innerText = myName;
    document.getElementById("my-profile-img").style.backgroundColor = getColorFromName(myName);
    loadMessages(); // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘
  }

  /* ===== Navigation Logic ===== */
  function switchTab(tabName, el) {
    // íƒ­ ìŠ¤íƒ€ì¼ í™œì„±í™”
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');

    // ì»¨í…ì¸  ì „í™˜
    document.getElementById('tab-friends').classList.add('hidden');
    document.getElementById('tab-chats').classList.add('hidden');
    
    if(tabName === 'friends') {
      document.getElementById('tab-friends').classList.remove('hidden');
      document.getElementById('header-title').innerText = "ì¹œêµ¬";
    } else {
      document.getElementById('tab-chats').classList.remove('hidden');
      document.getElementById('header-title').innerText = "ì±„íŒ…";
    }
  }

  function enterChat(roomName) {
    // ì±„íŒ…ë°© ì—´ê¸°
    document.getElementById('current-room-name').innerText = roomName;
    document.getElementById('view-chat').classList.add('open');
    isChatOpen = true;
    scrollToBottom();
  }

  function exitChat() {
    // ì±„íŒ…ë°© ë‹«ê¸° (í™ˆìœ¼ë¡œ ì´ë™)
    document.getElementById('view-chat').classList.remove('open');
    isChatOpen = false;
    // ê²€ìƒ‰ì°½ ë‹«ê¸°
    document.getElementById("search-area").classList.remove("active");
    searchKeyword = "";
    document.getElementById("search-input").value = "";
    renderMessages(allMessages); // ë¦¬ì…‹
  }

  function openCreateChatModal() { document.getElementById('createChatModal').style.display = 'flex'; }
  function createNewChat(type) {
    closeModal('createChatModal');
    // ì‹¤ì œë¡œëŠ” ì„œë²„ê°€ í•˜ë‚˜ì´ë¯€ë¡œ, ì´ë¦„ë§Œ ë°”ê¿”ì„œ ì…ì¥
    if (type === '1:1 ì±„íŒ…') enterChat('ìƒˆë¡œìš´ ëŒ€í™”ìƒëŒ€');
    else if (type === 'ê·¸ë£¹ ì±„íŒ…') enterChat('ê·¸ë£¹ ì±„íŒ…ë°© 1');
    else enterChat('ì˜¤í”ˆì±„íŒ…ë°©');
  }

  function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  
  function resetApp() {
    localStorage.clear();
    location.reload();
  }

  /* ===== Chat Logic ===== */
  function toggleInChatSearch() {
    const area = document.getElementById("search-area");
    area.classList.toggle("active");
    if (area.classList.contains("active")) document.getElementById("search-input").focus();
    else {
      searchKeyword = "";
      renderMessages(allMessages);
    }
  }

  function onSearch(val) {
    searchKeyword = val.trim();
    renderMessages(allMessages);
  }

  async function loadMessages() {
    try {
      const res = await fetch(API_URL + "/messages");
      const msgs = await res.json();
      if (JSON.stringify(msgs) !== JSON.stringify(allMessages)) {
        allMessages = msgs;
        renderMessages(allMessages);
      }
    } catch(e) { console.error(e); }
  }
  setInterval(loadMessages, 1000);

  function renderMessages(messages) {
    const chatBox = document.getElementById("chat-msgs");
    // ìŠ¤í¬ë¡¤ì´ ë°”ë‹¥ì¸ì§€ ì²´í¬ (ì±„íŒ…ë°©ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
    const isAtBottom = isChatOpen && (chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 150);

    chatBox.innerHTML = "";
    
    // í•„í„°ë§
    const displayList = messages.filter(m => !searchKeyword || m.msg.includes(searchKeyword));

    displayList.forEach(m => {
      const isMe = m.name.trim() === myName.trim();
      const typeClass = isMe ? "me" : "other";
      const profileColor = getColorFromName(m.name);
      
      let content = m.msg;
      if(searchKeyword) content = content.replaceAll(searchKeyword, `<span class="highlight">${searchKeyword}</span>`);

      const div = document.createElement("div");
      div.className = `msg-row ${typeClass}`;
      div.innerHTML = `
        ${!isMe ? `<div class="profile-thumb" style="width:34px; height:34px; border-radius:13px; margin-right:8px; background-color:${profileColor}"></div>` : ''}
        <div class="msg-content">
          ${!isMe ? `<div class="name">${m.name}</div>` : ''}
          <div class="bubble-wrapper">
            <div class="bubble">${content}</div>
            <div class="info">
              <div class="read-count">1</div>
              <div class="time">${m.time}</div>
            </div>
          </div>
        </div>
      `;
      chatBox.appendChild(div);
    });

    if (isAtBottom && !searchKeyword) scrollToBottom();
  }

  function scrollToBottom() {
    const chatBox = document.getElementById("chat-msgs");
    setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
  }

  function sendMsg() {
    const input = document.getElementById("msg-input-field");
    const msg = input.value.trim();
    if (!msg) return;

    fetch(API_URL + "/send", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name: myName, msg })
    }).then(() => loadMessages());

    input.value = "";
    input.focus();
  }

  document.getElementById("msg-input-field").addEventListener("keydown", e => {
    if(e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMsg();
    }
  });

</script>
</body>
</html>
