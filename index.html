<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>mintalk</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />
<link rel="icon" type="image/png" sizes="32x32" href="https://i.postimg.cc/7YKGq6tt/Chat-GPT-Image-2025nyeon-12wol-25il-ohu-11-48-18-removebg-preview.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.postimg.cc/7YKGq6tt/Chat-GPT-Image-2025nyeon-12wol-25il-ohu-11-48-18-removebg-preview.png">

<style>
  /* ===== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì—…ë°ì´íŠ¸ ===== */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  /* í•œê¸€ ì…ë ¥ ì˜¤ë¥˜ ìˆ˜ì •: touch-action ë° user-select ëª…ì‹œì  ì„¤ì • */
  input, textarea { touch-action: manipulation !important; -webkit-user-select: text; user-select: text; }
  html, body { margin: 0; padding: 0; width: 100%; height: 100vh; height: 100dvh; overflow: hidden; position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background-color: #fff; font-size: 13px; color: #000; }
  .hidden { display: none !important; }

  #view-login { width: 100%; height: 100%; background-color: #fef01b; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; z-index: 9999; top: 0; left: 0; }
  
  /* ë¡œê·¸ì¸ ë¡œê³  ì´ë¯¸ì§€ êµì²´ ë° ìƒ‰ìƒ ì ìš© */
  .login-logo-img { 
    width: 80px; 
    height: 80px; 
    margin-bottom: 40px; 
    background-color: #3b1e1e; /* ì•„ì´ì½˜ ìƒ‰ìƒ */
    -webkit-mask: url('https://i.postimg.cc/X7hwLjRr/image-removebg-preview-(1).png') no-repeat center / contain;
    mask: url('https://i.postimg.cc/X7hwLjRr/image-removebg-preview-(1).png') no-repeat center / contain;
  }

  .login-form { width: 80%; max-width: 280px; display: flex; flex-direction: column; gap: 10px; }
  .login-input { padding: 14px 20px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; background: #fff; }
  .login-btn { padding: 14px; background: #3b1e1e; color: #fff; border: none; border-radius: 50px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; height: 48px; display: flex; align-items: center; justify-content: center; }
  .login-error { color: #d93025; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
  .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #screen-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: none; }
  
  /* ëª¨ë°”ì¼ ì—¬ë°± ì¶”ê°€ */
  /* padding: 0 10px; ë¶€ë¶„ì„ 0ìœ¼ë¡œ ë³€ê²½ */
#main-layout { display: flex; width: 100%; height: 100%; padding: 0; background: #fff; }
  
  #left-side { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; border-right: 1px solid #eee; }
  
  .home-header { height: 52px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 20px; font-weight: 700; }
  .header-icons { display: flex; gap: 18px; }
  .icon { font-family: 'Material Symbols Outlined'; font-size: 26px; font-weight: 300; cursor: pointer; }
  
  .tab-content { width: 100%; height: calc(100% - 52px - 58px); overflow-y: auto; overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom); touch-action: pan-y; }
  .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; position: relative; }
  
  .profile-thumb { width: 44px; height: 44px; border-radius: 16px; background-color: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; color: rgba(0,0,0,0.5); font-size: 14px; margin-right: 12px; background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.05); }
  
  .list-item .text-area { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .list-item .name { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
  .list-item .desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .unread-badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: #ff5252; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: bold; }
  .badge-p { background: #ffeb3b; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }
  .badge-g { background: #ddd; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }

  .more-menu { padding: 20px 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
  .menu-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
  .menu-icon { font-size: 30px; color: #444; background: #f2f2f2; padding: 12px; border-radius: 50%; }
  .menu-text { font-size: 12px; }
  .my-info-card { display: flex; align-items: center; padding: 20px 16px; }

  .bottom-nav { height: calc(58px + env(safe-area-inset-bottom)); border-top: 1px solid #f1f1f1; display: flex; align-items: flex-start; justify-content: space-around; background: #fff; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); position: absolute; bottom: 0; width: 100%; z-index: 100; }
  .nav-item { display: flex; flex-direction: column; align-items: center; color: #bbb; cursor: pointer; width: 100%; }
  .nav-item.active { color: #333; }
  
  /* í•˜ë‹¨ íƒ­ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ë§ˆìŠ¤í‚¹) */
  .nav-icon-custom {
      width: 24px; height: 24px;
      background-color: #bbb;
      -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;
      mask-size: contain; mask-repeat: no-repeat; mask-position: center;
      transition: background-color 0.2s;
  }
  .nav-item.active .nav-icon-custom { background-color: #333; }
  
  /* ì±„íŒ… í™”ë©´ ë°°ê²½ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
  #view-chat { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; z-index: 200; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), visibility 0s 0.3s; visibility: hidden; }
  #view-chat.open { transform: translateX(0); visibility: visible; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), visibility 0s 0s; }
  
  #chat-loading-overlay { position: absolute; top: 50px; left: 0; width: 100%; bottom: calc(58px + env(safe-area-inset-bottom)); background: #fff; display: none; align-items: center; justify-content: center; z-index: 150; }
  .chat-loader { width: 35px; height: 35px; border: 4px solid rgba(0,0,0,0.1); border-top-color: #007bff; border-radius: 50%; animation: rotation 1s linear infinite; }

  #pc-placeholder { flex: 1; background: #f9f9f9; display: none; flex-direction: column; align-items: center; justify-content: center; color: #ccc; }
  #pc-placeholder .material-symbols-outlined { font-size: 64px; margin-bottom: 10px; }

  .chat-header { height: 50px; background: #fff; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative; z-index: 160; }
  .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; touch-action: pan-y; transition: opacity 0.3s ease; }
  
  .date-divider { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
  .date-divider span { background: rgba(0,0,0,0.05); color: #555; padding: 4px 12px; border-radius: 12px; font-size: 11px; }

  .msg-row { display: flex; width: 100%; flex-shrink: 0; position: relative; margin-bottom: 5px; }
  .msg-row.me { justify-content: flex-end; }
  .msg-row.other { justify-content: flex-start; align-items: flex-start; }

  .chat-profile-img { width: 36px; height: 36px; border-radius: 14px; margin-right: 8px; background-color: #eee; background-size: cover; background-position: center; flex-shrink: 0; cursor: pointer; display: none; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: rgba(0,0,0,0.5); }
  .msg-row.other .chat-profile-img { display: flex; }

  .msg-content { display: flex; flex-direction: column; max-width: 75%; }
  .me .msg-content { align-items: flex-end; }
  .other .msg-content { align-items: flex-start; }

  /* ë§í’ì„  ìŠ¤íƒ€ì¼ ë³€ê²½ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
  .bubble { padding: 10px 14px; font-size: 15px; word-break: break-all; white-space: pre-wrap; width: fit-content; line-height: 1.4; position: relative; text-align: left; }
  /* ìƒëŒ€ë°©: íšŒìƒ‰ ë°°ê²½, ë‘¥ê·¼ ëª¨ì„œë¦¬ */
  .other .bubble { background: #f0f0f0; color: #000; border-radius: 20px; border-top-left-radius: 4px; }
  /* ë‚˜: íŒŒë€ìƒ‰ ë°°ê²½, í°ìƒ‰ ê¸€ì”¨, ë‘¥ê·¼ ëª¨ì„œë¦¬ */
  .me .bubble { background: #3b82f6; color: #fff; border-radius: 20px; border-top-right-radius: 4px; cursor: pointer; }
  
  .bubble a { color: #007bff; text-decoration: none; cursor: pointer; }
  .me .bubble a { color: #fff; text-decoration: underline; }
  .bubble a:hover { text-decoration: underline; }

  .link-preview { display: block; margin-top: 8px; background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); max-width: 240px; text-decoration: none; color: inherit !important; cursor: pointer; }
  .link-preview img { width: 100%; height: 120px; object-fit: cover; display: block; }
  .preview-txt { padding: 10px; }
  .preview-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #000; }
  .preview-desc { font-size: 11px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  .read-container { display: flex; align-items: flex-end; }
  .me .read-container { flex-direction: row-reverse; }
  .read-count { font-size: 10px; color: #3b82f6; margin: 0 4px; font-weight: bold; }
  .me .read-count { color: #3b82f6; } 
  .msg-time { font-size: 10px; color: #999; margin: 0 4px; min-width: max-content; }

  /* ì´ë¯¸ì§€ ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ (20px) */
  .img-msg { max-width: 200px; border-radius: 20px; margin-top: 5px; display: block; cursor: pointer; }
  .edit-tag { font-size: 9px; color: rgba(0,0,0,0.4); margin-top: 2px; }

  /* ì…ë ¥ì°½ ì˜ì—­ ìŠ¤íƒ€ì¼ ì¬ì •ì˜ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
  #input-area { background: #fff; padding: 9px 10px calc(9px + env(safe-area-inset-bottom)) 10px; display: flex; gap: 8px; align-items: center; position: relative; z-index: 10; min-height: 58px; }
  
  /* í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ */
  #plus-btn { width: 40px; height: 40px; background: #f8f8f8; color: #555; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
  
  /* í”ŒëŸ¬ìŠ¤ ë©”ë‰´ (ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬) */
  #plus-menu { position: absolute; bottom: 60px; left: 10px; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 10px; display: none; flex-direction: column; gap: 10px; z-index: 100; min-width: 120px; }
  #plus-menu.show { display: flex; }
  .plus-menu-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; cursor: pointer; color: #333; font-size: 14px; }
  .plus-menu-item:hover { background: #f5f5f5; }

  /* ë©”ì‹œì§€ ì…ë ¥ ë°•ìŠ¤ (ë†’ì´ 32pxë¡œ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤) */
  #msg-input-container { flex: 1; background: #f4f4f4; border-radius: 30px; display: flex; align-items: center; padding: 0 15px; height: 40px; }
  #msg-input { flex: 1; background: transparent; border: none; outline: none; font-size: 15px; padding: 0; color: #000; height: 100%; margin: 0; }
  
  /* ë…¹ìŒ/ì „ì†¡ ë²„íŠ¼ ì˜ì—­ */
  #action-btn-area { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; }
  
  /* ë…¹ìŒ ì•„ì´ì½˜ (ì„¸ë¡œ ë§‰ëŒ€ ìŠ¤íƒ€ì¼) */
  #mic-icon { display: flex; align-items: center; justify-content: center; gap: 2px; height: 100%; }
  .bar { width: 3px; background-color: #555; border-radius: 2px; }
  .bar:nth-child(1) { height: 8px; }
  .bar:nth-child(2) { height: 16px; }
  .bar:nth-child(3) { height: 10px; }
  .bar:nth-child(4) { height: 14px; }
  .bar:nth-child(5) { height: 6px; }

  #send-btn { display: none; width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; border: none; align-items: center; justify-content: center; color: #fff; cursor: pointer; }
  #send-btn:disabled { background: #ccc; cursor: default; }
  
  /* ëª¨ë‹¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (z-index 3000ìœ¼ë¡œ ì˜¬ë ¤ì„œ ì´ë¯¸ì§€ ë·°ì–´ë³´ë‹¤ ì•ì— ë‚˜ì˜¤ê²Œ í•¨, ë”œë ˆì´ ë‹¨ì¶•) */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.1s ease; }
  .modal.show { opacity: 1; display: flex; }
  .modal-box { background: #fff; width: 85%; max-width: 300px; padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
  
  /* ë©”ì‹œì§€ ë©”ë‰´ ì „ìš© ìŠ¤íƒ€ì¼ */
  #msgMenuModal { background: transparent; pointer-events: none; opacity: 1; }
  #msgMenuModal .modal-box { 
    position: fixed; 
    width: 80px; 
    padding: 5px; 
    border-radius: 8px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    pointer-events: auto; 
    border: 1px solid #eee;
    transform: none;
    margin: 0;
  }
  #msgMenuModal .modal-btn { 
    width: 100%; 
    padding: 8px; 
    margin-top: 2px; 
    font-size: 12px; 
    border-radius: 4px; 
    font-weight: normal;
  }

  .modal-btn { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
  .bg-y { background: #3b82f6; color: #fff; } /* ë…¸ë€ìƒ‰ ëŒ€ì‹  íŒŒë€ìƒ‰ í…Œë§ˆ ì ìš© */
  .bg-g { background: #f2f2f2; color: #333; }
  .bg-r { background: #ff5252; color: #fff; }

  .friend-select-list { max-height: 150px; overflow-y: auto; text-align: left; margin: 10px 0; border: 1px solid #eee; padding: 5px; }
  .friend-select-item { display: flex; align-items: center; gap: 10px; padding: 5px; }
  
  .crop-container { width: 200px; height: 200px; overflow: hidden; margin: 0 auto; border: 1px solid #ddd; border-radius: 50%; position: relative; background: #000; }
  canvas#crop-canvas { cursor: move; }
  .slider-container { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }

  /* ì´ë¯¸ì§€ ë·°ì–´ ëª¨ë‹¬ (ìš”ì²­ì‚¬í•­ ë°˜ì˜) */
  #img-viewer-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; }
  #img-viewer-modal.show { opacity: 1; display: flex; }
  #img-viewer-content { max-width: 100%; max-height: 80vh; object-fit: contain; transform: scale(1); transition: transform 0.2s; }
  .viewer-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 2001; }
  .viewer-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); }

  /* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  #copy-btn-modal { display: block; }

  @media (min-width: 768px) {
    #left-side { width: 380px; flex-shrink: 0; }
    #view-chat { position: relative; transform: none; visibility: visible; display: none; z-index: 10; flex: 1; border-left: 1px solid #ddd; }
    #view-chat.open { display: flex; }
    #pc-placeholder { display: flex; }
    #view-chat.open ~ #pc-placeholder { display: none; }
    .chat-header .material-symbols-outlined[onclick="exitRoom()"] { display: none; }
  }



  
</style>

</head>
<body>

<div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999999; transition:opacity 0.5s ease; touch-action:none; pointer-events:all;">
    <style>
        .custom-logo {
            width: 30vw; max-width: 150px; min-width: 100px; aspect-ratio: 1/1; margin-bottom: 20px;
            background: linear-gradient(270deg, #FFB7CE, #B19CD9, #FFB7CE); background-size: 200% 100%;
            -webkit-mask: url('https://i.postimg.cc/D0DF0t9r/image-removebg-preview.png') no-repeat center / contain;
            mask: url('https://i.postimg.cc/D0DF0t9r/image-removebg-preview.png') no-repeat center / contain;
            animation: gradMove 2.5s linear infinite;
        }
        .custom-bar-bg { width: 50%; max-width: 200px; height: 5px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .custom-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #FFB7CE, #B19CD9); animation: loadFill 2s ease-in-out forwards; }
        @keyframes gradMove { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
        @keyframes loadFill { to { width: 100%; } }
    </style>
    <div class="custom-logo"></div>
    <div class="custom-bar-bg"><div class="custom-bar-fill"></div></div>
    <script>
        window.addEventListener('load', function() {
            const loader = document.getElementById('loading-overlay');
            setTimeout(() => { if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); } }, 2500);
        });
    </script>
</div>

<div id="view-login">
  <div class="login-logo-img"></div>
  <div class="login-form">
    <input id="login-id" class="login-input" placeholder="ì•„ì´ë””" autocomplete="off" lang="ko">
    <input id="login-pw" type="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="login-btn" onclick="handleLogin()">
      <span id="btn-text">ë¡œê·¸ì¸</span>
      <span id="btn-loader" class="loader hidden"></span>
    </button>
    <div id="login-msg" class="login-error"></div>
  </div>
</div>

<div id="screen-container">
  <div id="main-layout">
    <div id="left-side">
      <div id="view-home" style="width:100%; height:100%; display:flex; flex-direction:column;">
        <div class="home-header">
          <span id="header-title">ì¹œêµ¬</span>
          <div class="header-icons">
            <span class="icon" onclick="openCreateChatModal()">add_circle</span>
            <span class="icon">search</span>
          </div>
        </div>

        <div id="tab-friends" class="tab-content">
          <div class="my-info-card">
            <div class="profile-thumb" id="my-profile-img">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" id="my-name-display" style="font-size:16px;">ë‚˜</div>
              <div class="desc" id="my-status-display">ìƒíƒœë©”ì‹œì§€ ì…ë ¥ í•„ìš”</div>
            </div>
          </div>
          <hr style="border:0; border-top:1px solid #f5f5f5; margin:0 0 10px 0;">
          <div id="friends-list-container"></div>
        </div>

        <div id="tab-chats" class="tab-content hidden">
          <div id="chat-list-container"></div>
        </div>

        <div id="tab-more" class="tab-content hidden">
          <div class="my-info-card">
            <div class="profile-thumb" id="more-profile-img" style="cursor:pointer;" onclick="openProfileEdit()">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" style="font-size:18px; margin-bottom:5px;">ë”ë³´ê¸°</div>
              <div class="desc" id="more-email-display">user@email.com</div>
              <div class="desc" style="font-size:11px; color:#aaa; margin-top:2px;">ì‚¬ì§„ì„ ëˆŒëŸ¬ í”„ë¡œí•„ ë³€ê²½</div>
            </div>
          </div>
          <div class="status-editor" id="status-edit-area" style="padding: 0 16px; display: none;">
            <input id="new-status-input" class="login-input" style="width:100%; border-radius:8px; margin-bottom:8px;" placeholder="ìƒˆ ìƒíƒœë©”ì‹œì§€ ì…ë ¥">
            <div style="display:flex; gap:8px;">
              <button class="modal-btn bg-y" style="margin:0;" onclick="saveStatus()">ì €ì¥</button>
              <button class="modal-btn bg-g" style="margin:0;" onclick="toggleStatusEditor()">ì·¨ì†Œ</button>
            </div>
          </div>
        
          <div class="more-menu">
            <div class="menu-btn" onclick="toggleStatusEditor()"><span class="material-symbols-outlined menu-icon">edit_note</span><span class="menu-text">ìƒíƒœë³€ê²½</span></div>
            <div class="menu-btn" onclick="openClearHistoryConfirm()"><span class="material-symbols-outlined menu-icon">delete_sweep</span><span class="menu-text">ê¸°ë¡ì‚­ì œ</span></div>
            <div class="menu-btn" onclick="exportChat()"><span class="material-symbols-outlined menu-icon">download</span><span class="menu-text">ë‚´ë³´ë‚´ê¸°</span></div>
            <div class="menu-btn" onclick="importChat()"><span class="material-symbols-outlined menu-icon">upload</span><span class="menu-text">ê°€ì ¸ì˜¤ê¸°</span></div>
            <div class="menu-btn" onclick="logout()"><span class="material-symbols-outlined menu-icon" style="color:#d93025; background:#ffebeb;">logout</span><span class="menu-text" style="color:#d93025;">ë¡œê·¸ì•„ì›ƒ</span></div>
          </div>
        </div>

        <div class="bottom-nav">
          <div class="nav-item active" onclick="switchTab('friends', this)">
             <div class="nav-icon-custom" style="-webkit-mask-image: url('https://i.postimg.cc/kGSthK3Y/user.png'); mask-image: url('https://i.postimg.cc/kGSthK3Y/user.png');"></div>
          </div>
          <div class="nav-item" onclick="switchTab('chats', this)">
             <div class="nav-icon-custom" style="-webkit-mask-image: url('https://i.postimg.cc/X7hwLjRr/image-removebg-preview-(1).png'); mask-image: url('https://i.postimg.cc/X7hwLjRr/image-removebg-preview-(1).png');"></div>
          </div>
          <div class="nav-item" onclick="switchTab('more', this)"><span class="material-symbols-outlined" style="font-size:28px;">more_horiz</span></div>
        </div>
      </div>
    </div>

    <div id="view-chat">
      <header class="chat-header">
        <span class="material-symbols-outlined" style="font-size:24px; padding:10px; cursor:pointer;" onclick="exitRoom()">arrow_back</span>
        <div style="flex:1; font-weight:700; font-size:16px;" id="room-title">ì±„íŒ…ë°©</div>
        <span class="material-symbols-outlined" style="cursor:pointer; padding:10px;" onclick="openChatMenu()">menu</span>
      </header>
      
      <div id="chat-loading-overlay">
          <div class="chat-loader"></div>
      </div>

      <div id="chat-msgs" class="chat-msgs"></div>
      
      <div id="input-area">
        <button id="plus-btn" onclick="togglePlusMenu()">
          <span class="material-symbols-outlined" style="font-size:20px;">add</span>
        </button>

        <div id="plus-menu">
            <div class="plus-menu-item" onclick="triggerCamera()">
                <span class="material-symbols-outlined" style="color:#e91e63;">photo_camera</span> ì¹´ë©”ë¼
            </div>
            <div class="plus-menu-item" onclick="triggerGallery()">
                <span class="material-symbols-outlined" style="color:#4caf50;">image</span> ì‚¬ì§„
            </div>
        </div>

        <input type="file" id="img-input-camera" class="hidden" accept="image/*" capture="environment" onchange="sendImage(this)">
        <input type="file" id="img-input-gallery" class="hidden" accept="image/*" onchange="sendImage(this)">
        
        <div id="msg-input-container">
            <input id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off" lang="ko">
        </div>

        <div id="action-btn-area">
            <div id="mic-icon">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <button id="send-btn" onclick="sendMsg()">
                <span id="send-icon" class="material-symbols-outlined" style="font-size:18px;">arrow_upward</span>
                <span id="send-loader" class="loader hidden" style="border-color:#fff; border-bottom-color:transparent; width:14px; height:14px; border-width:2px;"></span>
            </button>
        </div>
      </div>
    </div>

    <div id="pc-placeholder">
      <span class="material-symbols-outlined">chat_bubble</span>
      <p>ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
    </div>
  </div>
</div>

<div id="alertModal" class="modal">
  <div class="modal-box">
    <p id="alert-message" style="margin-bottom:20px; line-height:1.6;"></p>
    <button class="modal-btn bg-y" onclick="closeModal('alertModal')">í™•ì¸</button>
  </div>
</div>

<div id="confirmModal" class="modal">
  <div class="modal-box">
    <p id="confirm-message" style="margin-bottom:20px; line-height:1.6;"></p>
    <div style="display:flex; gap:10px;">
        <button class="modal-btn bg-g" style="margin:0;" onclick="closeModal('confirmModal')">ì·¨ì†Œ</button>
        <button id="confirm-ok-btn" class="modal-btn bg-r" style="margin:0;">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="editMsgModal" class="modal">
  <div class="modal-box">
    <h3 style="margin-top:0;">ë©”ì‹œì§€ ìˆ˜ì •</h3>
    <textarea id="edit-msg-input" class="login-input" style="width:100%; border-radius:10px; height:80px; resize:none; padding:10px; margin-bottom:15px;"></textarea>
    <div style="display:flex; gap:10px;">
        <button class="modal-btn bg-g" style="margin:0;" onclick="closeModal('editMsgModal')">ì·¨ì†Œ</button>
        <button class="modal-btn bg-y" style="margin:0;" onclick="submitEditMsg()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="createChatModal" class="modal">
  <div class="modal-box">
    <h3>ìƒˆë¡œìš´ ì±„íŒ…</h3>
    <input id="new-room-name" class="login-input" style="width:100%; margin-top:10px; border-radius:10px;" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ê°€ì¡±ë°©)">
    <div class="friend-select-list" id="friend-select-container"></div>
    <button class="modal-btn bg-y" onclick="createGroupChat()">ë§Œë“¤ê¸°</button>
    <button class="modal-btn bg-g" onclick="closeModal('createChatModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="chatMenuModal" class="modal">
  <div class="modal-box">
    <h3 id="menu-room-name">ì±„íŒ…ë°© ì„¤ì •</h3>
    <button class="modal-btn bg-g" onclick="openLeaveRoomConfirm()">ì±„íŒ…ë°© ë‚˜ê°€ê¸° (ë‚˜ë§Œ)</button>
    <button class="modal-btn bg-r" id="del-room-btn" onclick="openDeleteRoomConfirm()">ì±„íŒ…ë°© ì‚­ì œ (ëª¨ë‘ì—ê²Œì„œ)</button>
    <button class="modal-btn bg-g" onclick="closeModal('chatMenuModal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="msgMenuModal" class="modal">
  <div class="modal-box">
    <button id="copy-btn-modal" class="modal-btn bg-g" onclick="copyMsgText()" style="display:none;">ë³µì‚¬</button>
    <button id="edit-btn-modal" class="modal-btn bg-y" onclick="openEditModal()">ìˆ˜ì •</button>
    <button class="modal-btn bg-r" onclick="openDeleteMsgConfirm()">ì‚­ì œ</button>
    <button class="modal-btn bg-g" onclick="closeModal('msgMenuModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="img-viewer-modal" onclick="closeImageViewer(event)">
    <img id="img-viewer-content">
    <div class="viewer-controls" onclick="event.stopPropagation()">
        <div class="viewer-btn" onclick="downloadImage()">
            <span class="material-symbols-outlined">download</span>
        </div>
        <div class="viewer-btn" onclick="deleteViewingImage()" style="border-color:#ff5252; color:#ff5252;">
            <span class="material-symbols-outlined">delete</span>
        </div>
        <div class="viewer-btn" onclick="closeImageViewerDirect()">
            <span class="material-symbols-outlined">close</span>
        </div>
    </div>
</div>

<div id="profileEditModal" class="modal">
  <div class="modal-box">
    <h3>í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</h3>
    <div class="crop-container"><canvas id="crop-canvas" width="200" height="200"></canvas></div>
    <div class="slider-container">
        <span class="material-symbols-outlined" style="font-size:16px;">remove</span>
        <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" oninput="handleImageZoom(this.value)">
        <span class="material-symbols-outlined" style="font-size:16px;">add</span>
    </div>
    <button class="modal-btn bg-y" onclick="document.getElementById('profile-file-input').click()">ì‚¬ì§„ ì„ íƒ</button>
    <button class="modal-btn bg-y" onclick="saveProfileImage()">ì €ì¥</button>
    <button class="modal-btn bg-g" onclick="openDeleteProfileConfirm()">ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½</button>
    <button class="modal-btn bg-g" style="margin-top:15px;" onclick="closeModal('profileEditModal')">ë‹«ê¸°</button>
  </div>
</div>

<input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport(this)">
<input type="file" id="profile-file-input" class="hidden" accept="image/*" onchange="handleProfileSelect(this)">

<script>
  const API_URL = "https://jaewondev3.pythonanywhere.com";
  
  let myId = localStorage.getItem("myId");
  let myName = localStorage.getItem("myName");
  let myStatus = localStorage.getItem("myStatus") || "";
  let myProfileImg = localStorage.getItem("myProfileImg") || ""; 
  let friendList = JSON.parse(localStorage.getItem("friendList") || "[]");
  let myChatRooms = JSON.parse(localStorage.getItem("myChatRooms") || "[]");
  let allMessagesCache = {}; 
  let currentRoomId = null;
  let chatPollInterval = null;
  let listPollInterval = null;
  let selectedMsgId = null;
  let viewingImgId = null; // ì´ë¯¸ì§€ ë·°ì–´ì—ì„œ ë³´ê³  ìˆëŠ” ë©”ì‹œì§€ ID
  let viewingImgUrl = null; // ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•œ URL
  let isInitialLoad = true;

  let cropImg = new Image();
  let cropScale = 1;
  let cropOffsetX = 0;
  let cropOffsetY = 0;
  let isDragging = false;
  let startX, startY;

  const pastelColors = ["#FFB7B2", "#FFDAC1", "#E2F0CB", "#B5EAD7", "#C7CEEA", "#e4c1f9"];
  function getColor(s) { return pastelColors[(s || "").length % pastelColors.length]; }

  /* ================= ëª¨ë‹¬ í—¬í¼ í•¨ìˆ˜ ================= */
  function openModal(id) {
    const el = document.getElementById(id);
    el.style.display = "flex";
    setTimeout(() => el.classList.add("show"), 10);
  }
  function closeModal(id) {
    const el = document.getElementById(id);
    el.classList.remove("show");
    // ë”œë ˆì´ë¥¼ 200msì—ì„œ 100msë¡œ ì¤„ì—¬ì„œ ë°˜ì‘ì„± ê°œì„ 
    setTimeout(() => el.style.display = "none", 100);
  }
  function showCustomAlert(msg) {
    document.getElementById("alert-message").innerText = msg;
    openModal("alertModal");
  }
  function showCustomConfirm(msg, onConfirm) {
    document.getElementById("confirm-message").innerText = msg;
    const okBtn = document.getElementById("confirm-ok-btn");
    okBtn.onclick = () => { onConfirm(); closeModal("confirmModal"); };
    openModal("confirmModal");
  }

  if (myId) initApp();

  async function handleLogin() {
    const id = document.getElementById("login-id").value;
    const pw = document.getElementById("login-pw").value;
    const btnText = document.getElementById("btn-text");
    const loader = document.getElementById("btn-loader");
    const msgBox = document.getElementById("login-msg");
    btnText.classList.add("hidden"); loader.classList.remove("hidden"); msgBox.style.display = "none";
    try {
      const res = await fetch(API_URL + "/login", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id, password:pw})
      });
      const data = await res.json();
      if(data.success) {
        myId = data.id; myName = data.name; myStatus = data.status; 
        friendList = data.friendList; myProfileImg = data.profile_img || "";
        localStorage.setItem("myId", myId); localStorage.setItem("myName", myName);
        localStorage.setItem("myStatus", myStatus); 
        localStorage.setItem("friendList", JSON.stringify(friendList));
        localStorage.setItem("myProfileImg", myProfileImg);
        initApp();
      } else { throw new Error(data.message); }
    } catch(err) {
      msgBox.innerText = err.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨"; msgBox.style.display = "block";
      btnText.classList.remove("hidden"); loader.classList.add("hidden");
    }
  }

  function initApp() {
    document.getElementById("view-login").style.display = "none";
    document.getElementById("screen-container").style.display = "block";
    updateMyInfoUI(); renderFriends(); renderChatList();
    fetchAllMessages();
    listPollInterval = setInterval(() => { syncRoomsFromServer(); syncFriends(); }, 2000);
    initCanvasEvents();
    
    window.addEventListener('mousedown', (e) => {
      const modal = document.getElementById('msgMenuModal');
      const box = modal.querySelector('.modal-box');
      if(modal.style.display === 'flex' && !box.contains(e.target)) {
        closeModal('msgMenuModal');
      }
    });
    
    // ì…ë ¥ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë§ˆì´í¬/ì „ì†¡ ë²„íŠ¼ ìŠ¤ì™‘)
    const msgInput = document.getElementById("msg-input");
    const micIcon = document.getElementById("mic-icon");
    const sendBtn = document.getElementById("send-btn");
    
    msgInput.addEventListener('input', function() {
        if(this.value.trim().length > 0) {
            micIcon.style.display = "none";
            sendBtn.style.display = "flex";
        } else {
            micIcon.style.display = "flex";
            sendBtn.style.display = "none";
        }
    });

    // ì˜ì—­ ë°– í´ë¦­ì‹œ í”ŒëŸ¬ìŠ¤ ë©”ë‰´ ë‹«ê¸°
    window.addEventListener('click', (e) => {
        const menu = document.getElementById('plus-menu');
        const btn = document.getElementById('plus-btn');
        if (!menu.contains(e.target) && !btn.contains(e.target) && menu.classList.contains('show')) {
            menu.classList.remove('show');
        }
    });
  }

  /* í”ŒëŸ¬ìŠ¤ ë©”ë‰´ ê¸°ëŠ¥ */
  function togglePlusMenu() {
      const menu = document.getElementById("plus-menu");
      if (menu.classList.contains("show")) menu.classList.remove("show");
      else menu.classList.add("show");
  }
  function triggerCamera() {
      document.getElementById('img-input-camera').click();
      document.getElementById("plus-menu").classList.remove("show");
  }
  function triggerGallery() {
      document.getElementById('img-input-gallery').click();
      document.getElementById("plus-menu").classList.remove("show");
  }

  async function fetchAllMessages() {
      try {
          const res = await fetch(`${API_URL}/get-all-messages?id=${myId}`);
          const data = await res.json();
          allMessagesCache = data;
      } catch(e) {}
  }

  async function syncRoomsFromServer() {
    try {
      const res = await fetch(`${API_URL}/my-rooms?name=${myName}&id=${myId}`);
      const serverRooms = await res.json();
      let changed = false;
      serverRooms.forEach(sr => {
        const local = myChatRooms.find(r => r.id === sr.id);
        if(!local) {
          let title = sr.id.startsWith('private') ? sr.id.replace('private_','').replace(myId,'').replace('_','') : sr.id.replace('group_','');
          if(sr.id.startsWith('private')) {
            const f = friendList.find(fr => sr.id.includes(fr.id));
            if(f) title = f.name;
          }
          myChatRooms.unshift({ id: sr.id, title, type: sr.id.split('_')[0], lastMsg: sr.lastMsg, lastReadCount: 0, creator: sr.creator, messages_count: sr.messages_count, lastSender: sr.lastSender });
          changed = true;
        } else if(local.messages_count !== sr.messages_count) {
          local.messages_count = sr.messages_count; local.lastMsg = sr.lastMsg; local.lastSender = sr.lastSender;
          changed = true;
          if(currentRoomId === sr.id) loadMsgs();
        }
      });
      if(changed) { localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms)); renderChatList(); }
    } catch(e) {}
  }

  async function syncFriends() {
      try {
          const res = await fetch(`${API_URL}/get-friend-list?id=${myId}`);
          const newList = await res.json();
          if(JSON.stringify(friendList) !== JSON.stringify(newList)) {
              friendList = newList; localStorage.setItem("friendList", JSON.stringify(friendList));
              renderFriends(); renderChatList(); if(currentRoomId) loadMsgs();
          }
      } catch(e) {}
  }

  function setProfileImg(elId, imgData, fallbackName) {
    const el = document.getElementById(elId); if (!el) return;
    if (imgData) { el.innerText = ""; el.style.backgroundImage = `url(${imgData})`; el.style.backgroundColor = "transparent"; } 
    else { el.style.backgroundImage = "none"; el.innerText = fallbackName ? fallbackName[0] : "?"; el.style.backgroundColor = fallbackName ? getColor(fallbackName) : "#eee"; }
  }

  function updateMyInfoUI() {
    document.getElementById("my-name-display").innerText = myName;
    document.getElementById("my-status-display").innerText = myStatus || "ìƒíƒœë©”ì‹œì§€ ì—†ìŒ";
    document.getElementById("more-email-display").innerText = myId + "@mintalk.kro.kr";
    setProfileImg("my-profile-img", myProfileImg, myName);
    setProfileImg("more-profile-img", myProfileImg, myName);
  }

  function logout() { localStorage.clear(); location.reload(); }

  function switchTab(tab, el) {
    document.querySelectorAll(".nav-item").forEach(e => e.classList.remove("active"));
    el.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(e => e.classList.add("hidden"));
    document.getElementById(`tab-${tab}`).classList.remove("hidden");
    const titles = { friends: "ì¹œêµ¬", chats: "ì±„íŒ…", more: "ë”ë³´ê¸°" };
    document.getElementById("header-title").innerText = titles[tab];
    if(tab === 'chats') renderChatList();
  }

  function enterRoom(id, title, type) {
    if(chatPollInterval) { clearInterval(chatPollInterval); chatPollInterval = null; }
    
    const msgBox = document.getElementById("chat-msgs");
    const loader = document.getElementById("chat-loading-overlay");
    msgBox.style.opacity = "0";
    msgBox.innerHTML = "";
    loader.style.display = "flex";
    isInitialLoad = true;

    currentRoomId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("view-chat").classList.add("open");
    
    const room = myChatRooms.find(r => r.id === id);
    if (room) room.lastReadCount = room.messages_count || 0;
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));

    loadMsgs();
    chatPollInterval = setInterval(loadMsgs, 1000);
  }

  function exitRoom() {
    document.getElementById("view-chat").classList.remove("open");
    if(chatPollInterval) { clearInterval(chatPollInterval); chatPollInterval = null; }
    currentRoomId = null;
    setTimeout(renderChatList, 300);
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    document.getElementById("msg-input").value = "";
    document.getElementById("mic-icon").style.display = "flex";
    document.getElementById("send-btn").style.display = "none";
  }

  function renderChatList() {
    const container = document.getElementById("chat-list-container");
    container.innerHTML = "";
    if(myChatRooms.length === 0) {
      container.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>ì§„í–‰ ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    myChatRooms.forEach(room => {
      const isPrivate = room.type === 'private';
      const iconChar = isPrivate ? (room.title ? room.title[0] : '?') : 'ğŸ“¢';
      let roomImg = null;
      if(isPrivate) { const friend = friendList.find(f => room.id.includes(f.id)); if(friend && friend.profile_img) roomImg = friend.profile_img; }
      const badge = isPrivate ? `<span class="badge-p">1:1</span>` : `<span class="badge-g">ë‹¨ì²´</span>`;
      let unreadCount = (room.messages_count || 0) - (room.lastReadCount || 0);
      if(room.lastSender === myName) unreadCount = 0; 
      const unreadHtml = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : "";
      const div = document.createElement("div"); div.className = "list-item";
      div.onclick = () => enterRoom(room.id, room.title, room.type);
      let imgHtml = `<div class="profile-thumb" style="background:${getColor(room.title||"")}">${iconChar}</div>`;
      if(roomImg) imgHtml = `<div class="profile-thumb" style="background-image:url(${roomImg}); background-color:transparent;"></div>`;
      div.innerHTML = `${imgHtml}<div class="text-area"><div class="name">${room.title}</div><div class="desc">${badge} ${room.lastMsg || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ'}</div></div>${unreadHtml}`;
      container.appendChild(div);
    });
  }

  async function loadMsgs() {
    if(!currentRoomId) return;
    const initialRoomId = currentRoomId;
    try {
      const res = await fetch(`${API_URL}/messages?room=${currentRoomId}`);
      const msgs = await res.json();
      if(initialRoomId !== currentRoomId) return;
      allMessagesCache[currentRoomId] = msgs;
      renderMsgs(msgs);

      if(isInitialLoad) {
          document.getElementById("chat-loading-overlay").style.display = "none";
          document.getElementById("chat-msgs").style.opacity = "1";
          isInitialLoad = false;
      }

      await fetch(`${API_URL}/mark-read`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, id: myId }) });
      const room = myChatRooms.find(r => r.id === currentRoomId);
      if(room) { room.messages_count = msgs.length; room.lastReadCount = msgs.length; }
    } catch(e) {}
  }

  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank">${url}</a>`);
  }

  function formatDate(ts) {
      const date = new Date(parseFloat(ts) * 1000);
      return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
  }

  function renderMsgs(msgs) {
    const box = document.getElementById("chat-msgs");
    const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
    box.innerHTML = ""; let lastDate = "";
    msgs.forEach(m => {
      const currentDate = formatDate(m.id);
      if(currentDate !== lastDate) {
          const d = document.createElement("div"); d.className = "date-divider"; d.innerHTML = `<span>${currentDate}</span>`;
          box.appendChild(d); lastDate = currentDate;
      }
      const isMe = m.name === myName;
      const div = document.createElement("div"); div.className = `msg-row ${isMe ? 'me' : 'other'}`;
      let senderImg = "";
      if(!isMe) {
          const f = friendList.find(fr => fr.name === m.name);
          if(f && f.profile_img) senderImg = `background-image:url(${f.profile_img}); background-color:transparent;`;
          else senderImg = `background-color:${getColor(m.name)}`;
      }
      let readCountDisplay = (m.read_by && isMe && m.read_by.length < 2) ? "1" : "";
      
      // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ë·°ì–´ í˜¸ì¶œ (isMe ìƒê´€ì—†ì´)
      let contentHtml = m.image 
  ? `<img src="${m.image}" class="img-msg" onclick="openImageViewer('${m.image}', '${m.id}', ${isMe})">` 
  : `<div class="bubble" onclick="${isMe ? `openMsgMenu(event, '${m.id}', false)` : `openOtherMsgMenu(event, '${m.id}')`}">${linkify(m.msg)}</div>`;
      
      if(m.preview) contentHtml += `<a href="${m.preview.url}" target="_blank" class="link-preview">${m.preview.image ? `<img src="${m.preview.image}">` : ''}<div class="preview-txt"><div class="preview-title">${m.preview.title}</div><div class="preview-desc">${m.preview.description}</div></div></a>`;
      if(m.edited) contentHtml += `<span class="edit-tag">ìˆ˜ì •ë¨</span>`;
      div.innerHTML = `${!isMe ? `<div class="chat-profile-img" style="${senderImg}">${senderImg.includes('url')?'':m.name[0]}</div>` : ''}<div class="msg-content">${!isMe ? `<span style="font-size:11px; margin-bottom:4px; margin-left:2px; color:#666;">${m.name}</span>` : ''}<div class="read-container">${contentHtml}<div style="display:flex; flex-direction:column; justify-content:flex-end;"><span class="read-count">${readCountDisplay}</span><span class="msg-time">${m.time}</span></div></div></div>`;
      box.appendChild(div);
    });
    if(isAtBottom || isInitialLoad) box.scrollTop = box.scrollHeight;
  }

  async function sendMsg() {
    const input = document.getElementById("msg-input"); const btn = document.getElementById("send-btn");
    const icon = document.getElementById("send-icon"); const loader = document.getElementById("send-loader");
    const mic = document.getElementById("mic-icon");
    
    const msg = input.value.trim(); if(!msg) return;
    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");
    try {
      await fetch(API_URL + "/send", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, name: myName, msg: msg }) });
      input.value = ""; 
      // ì „ì†¡ í›„ ì…ë ¥ì°½ ìƒíƒœ ì´ˆê¸°í™” (ë§ˆì´í¬ ë³´ì´ê¸°, ì „ì†¡ë²„íŠ¼ ìˆ¨ê¸°ê¸°)
      mic.style.display = "flex";
      btn.style.display = "none";
      loadMsgs();
    } finally { btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden"); input.focus(); }
  }

  async function sendImage(input) {
    const file = input.files[0]; if(!file) return;
    // ë¡œë”© í‘œì‹œ (í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ ëŒ€ì‹  ì „ì†¡ ë²„íŠ¼ìª½ ì‚¬ìš©í•˜ê±°ë‚˜ ê¸€ë¡œë²Œ ë¡œë” ì‚¬ìš© ë“±) - ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ ì „ì†¡ë²„íŠ¼ ë¡œì§ í™œìš©
    const btn = document.getElementById("send-btn"); const icon = document.getElementById("send-icon"); const loader = document.getElementById("send-loader");
    
    // ê°•ì œë¡œ ì „ì†¡ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° (ë¡œë”© í‘œì‹œìš©)
    const mic = document.getElementById("mic-icon");
    mic.style.display = "none"; btn.style.display = "flex";

    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.createElement('canvas'); let width = img.width, height = img.height, max_size = 800;
        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } } else { if (height > max_size) { width *= max_size / height; height = max_size; } }
        canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        try { await fetch(API_URL + "/send", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, name: myName, image: compressedBase64, msg: "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤." }) }); loadMsgs(); } 
        finally { 
            btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden"); 
            // ì›ë³µ
            mic.style.display = "flex"; btn.style.display = "none";
        }
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file); input.value = "";
  }

  /* ì´ë¯¸ì§€ ë·°ì–´ ê´€ë ¨ í•¨ìˆ˜ */
  function openImageViewer(imgUrl, msgId, isMe) {
      viewingImgId = msgId;
      viewingImgUrl = imgUrl;
      const modal = document.getElementById('img-viewer-modal');
      const content = document.getElementById('img-viewer-content');
     // ì‚­ì œ ë²„íŠ¼(íœ´ì§€í†µ ì•„ì´ì½˜)ì„ ì°¾ì•„ì„œ ë‚´ ì´ë¯¸ì§€ì¼ ë•Œë§Œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
    const deleteBtn = document.querySelector('.viewer-btn[onclick="deleteViewingImage()"]');
    if (isMe) {
        deleteBtn.style.display = "flex";
    } else {
        deleteBtn.style.display = "none";
    }

    
      content.src = imgUrl;
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);
  }

  function closeImageViewer(e) {
      // ì´ë¯¸ì§€ë‚˜ ì»¨íŠ¸ë¡¤ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
      if (e.target.id === 'img-viewer-modal') {
          closeImageViewerDirect();
      }
  }

  function closeImageViewerDirect() {
      const modal = document.getElementById('img-viewer-modal');
      modal.classList.remove('show');
      setTimeout(() => {
          modal.style.display = 'none';
          document.getElementById('img-viewer-content').src = '';
      }, 200);
  }

  function downloadImage() {
      if(!viewingImgUrl) return;
      const a = document.createElement('a');
      a.href = viewingImgUrl;
      a.download = `image_${Date.now()}.jpg`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
  }

  function deleteViewingImage() {
      if(!viewingImgId) return;
      showCustomConfirm("ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
          await fetch(API_URL + "/delete-msg", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, msgId: viewingImgId }) });
          closeImageViewerDirect();
          loadMsgs();
      });
  }

  function openMsgMenu(e, id, isImage) {
    selectedMsgId = id;
    const modal = document.getElementById("msgMenuModal");
    const box = modal.querySelector('.modal-box');
    document.getElementById("edit-btn-modal").style.display = isImage ? "none" : "block";
    document.getElementById("copy-btn-modal").style.display = "none"; // ë‚´ ë©”ì‹œì§€ëŠ” ë³µì‚¬ ë²„íŠ¼ ìˆ¨ê¹€ (ê¸°ì¡´ ìœ ì§€)
    
    modal.style.display = "flex";
    let x = e.clientX; let y = e.clientY;
    if (x + 90 > window.innerWidth) x -= 90;
    if (y + 100 > window.innerHeight) y -= 100;
    box.style.left = x + "px"; box.style.top = y + "px";
  }

  /* ìƒëŒ€ë°© ë©”ì‹œì§€ í´ë¦­ ì‹œ ë©”ë‰´ (ë³µì‚¬ ê¸°ëŠ¥) */
  function openOtherMsgMenu(e, id) {
      selectedMsgId = id;
      const modal = document.getElementById("msgMenuModal");
      const box = modal.querySelector('.modal-box');
      
      // ìƒëŒ€ë°© ë©”ì‹œì§€: ìˆ˜ì •/ì‚­ì œ ìˆ¨ê¸°ê³  ë³µì‚¬/ì·¨ì†Œë§Œ í‘œì‹œ (ì‚­ì œë„ ìˆ¨ê¸°ëŠ”ê²Œ ì¼ë°˜ì ì´ë‚˜ ìš”ì²­ì— "ë³µì‚¬ ë²„íŠ¼" ì–¸ê¸‰ë§Œ ìˆì–´ ì‚­ì œëŠ” ë†”ë‘˜ ìˆ˜ë„ ìˆìœ¼ë‚˜, ë³´í†µ ìƒëŒ€ ë©”ì‹œì§€ ì‚­ì œëŠ” ì•ˆë¨. ì—¬ê¸°ì„  ë³µì‚¬ë§Œ ë³´ì´ê²Œ ì²˜ë¦¬)
      // ê¸°ì¡´ ì½”ë“œìƒ ì‚­ì œ APIëŠ” ë³¸ì¸ ê²ƒ ì²´í¬ ì•ˆí•˜ë©´ ì‚­ì œë  ìˆ˜ë„ ìˆì§€ë§Œ UIìƒ ê°€ë ¤ì¤Œ
      const menuBtns = box.querySelectorAll('.modal-btn');
      menuBtns.forEach(btn => btn.style.display = 'none');
      
      document.getElementById("copy-btn-modal").style.display = "block";
      menuBtns[menuBtns.length-1].style.display = "block"; // ì·¨ì†Œ ë²„íŠ¼
      
      modal.style.display = "flex";
      let x = e.clientX; let y = e.clientY;
      if (x + 90 > window.innerWidth) x -= 90;
      if (y + 100 > window.innerHeight) y -= 100;
      box.style.left = x + "px"; box.style.top = y + "px";
  }

  function copyMsgText() {
      const roomMsgs = allMessagesCache[currentRoomId] || [];
      const target = roomMsgs.find(m => m.id === selectedMsgId);
      if(target && target.msg) {
          navigator.clipboard.writeText(target.msg).then(() => {
              // ë³µì‚¬ ì„±ê³µ í”¼ë“œë°± ì—†ì´ ë‹«ê¸° or ì–¼ëŸ¿? ì—¬ê¸°ì„  ê·¸ëƒ¥ ë‹«ê¸°
          });
      }
      closeModal('msgMenuModal');
  }

  /* ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ ì—°ë™ */
  function openEditModal() {
    closeModal('msgMenuModal');
    const roomMsgs = allMessagesCache[currentRoomId] || [];
    const target = roomMsgs.find(m => m.id === selectedMsgId);
    if(target) {
        document.getElementById("edit-msg-input").value = target.msg;
        openModal("editMsgModal");
    }
  }

  async function submitEditMsg() {
    const newMsg = document.getElementById("edit-msg-input").value.trim();
    if(!newMsg) return;
    await fetch(API_URL + "/edit-msg", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId, msg: newMsg }) });
    closeModal('editMsgModal');
    loadMsgs();
  }

  function openDeleteMsgConfirm() {
      closeModal('msgMenuModal');
      showCustomConfirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?", async () => {
          await fetch(API_URL + "/delete-msg", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId }) });
          loadMsgs();
      });
  }

  function openChatMenu() {
    const room = myChatRooms.find(r => r.id === currentRoomId);
    document.getElementById("menu-room-name").innerText = room.title;
    document.getElementById("del-room-btn").style.display = (room.type === 'group') ? "block" : "none";
    openModal("chatMenuModal");
  }

  function openLeaveRoomConfirm() {
      closeModal('chatMenuModal');
      showCustomConfirm("ë¦¬ìŠ¤íŠ¸ì—ì„œ ì´ ì±„íŒ…ë°©ì„ ì—†ì•¨ê¹Œìš”?", () => {
          myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId); 
          localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
          exitRoom();
      });
  }

  function openDeleteRoomConfirm() {
      closeModal('chatMenuModal');
      showCustomConfirm("ì´ ì±„íŒ…ë°©ì˜ ëª¨ë“  ë‚´ìš©ì„ ì‚­ì œí•˜ê³  ë°©ì„ ì—†ì•¨ê¹Œìš”?", async () => {
          await fetch(API_URL + "/delete-room", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: currentRoomId }) });
          myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId); 
          localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
          exitRoom();
      });
  }

  function openCreateChatModal() {
    const container = document.getElementById("friend-select-container"); container.innerHTML = "";
    friendList.forEach(f => { container.innerHTML += `<div class="friend-select-item"><input type="checkbox" name="invited-friend" value="${f.name}" id="chk-${f.id}"><label for="chk-${f.id}">${f.name}</label></div>`; });
    openModal("createChatModal");
  }

  function createGroupChat() {
    const name = document.getElementById("new-room-name").value.trim(); const checked = document.querySelectorAll('input[name="invited-friend"]:checked');
    if(!name) return showCustomAlert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    let participants = [myName]; checked.forEach(c => participants.push(c.value));
    const roomId = `group_${Date.now()}`; enterRoom(roomId, name, 'group');
    fetch(API_URL + "/send", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ room: roomId, name: "System", msg: `${myName}ë‹˜ì´ ë°©ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`, participants: participants }) });
    closeModal('createChatModal');
  }

  function startPrivateChat(friendId, friendName) {
    const sorted = [myId, friendId].sort(); const roomId = `private_${sorted[0]}_${sorted[1]}`;
    enterRoom(roomId, friendName, 'private');
  }

  function openProfileEdit() {
      const cvs = document.getElementById("crop-canvas"); const ctx = cvs.getContext("2d");
      ctx.clearRect(0, 0, cvs.width, cvs.height); ctx.fillStyle = "#eee"; ctx.fillRect(0,0, cvs.width, cvs.height);
      if(myProfileImg) { cropImg.src = myProfileImg; cropImg.onload = () => { cropScale = 1; cropOffsetX = 0; cropOffsetY = 0; document.getElementById("zoom-slider").value = 1; drawCropCanvas(); } }
      openModal("profileEditModal");
  }

  function handleProfileSelect(input) {
      const file = input.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
          cropImg = new Image();
          cropImg.onload = () => {
              const cvs = document.getElementById("crop-canvas");
              const baseScale = Math.max(cvs.width / cropImg.width, cvs.height / cropImg.height);
              cropScale = baseScale; cropOffsetX = 0; cropOffsetY = 0;
              const slider = document.getElementById("zoom-slider"); slider.min = baseScale * 0.5; slider.max = baseScale * 5; slider.value = baseScale;
              drawCropCanvas();
          };
          cropImg.src = e.target.result;
      };
      reader.readAsDataURL(file); input.value = "";
  }

  function drawCropCanvas() {
      const cvs = document.getElementById("crop-canvas"); const ctx = cvs.getContext("2d"); if (!cropImg.src) return;
      ctx.clearRect(0, 0, cvs.width, cvs.height);
      const sw = cropImg.width * cropScale, sh = cropImg.height * cropScale;
      ctx.drawImage(cropImg, (cvs.width - sw) / 2 + cropOffsetX, (cvs.height - sh) / 2 + cropOffsetY, sw, sh);
  }

  function handleImageZoom(val) { cropScale = parseFloat(val); drawCropCanvas(); }

  function initCanvasEvents() {
      const cvs = document.getElementById("crop-canvas");
      const startDrag = (x, y) => { isDragging = true; startX = x; startY = y; };
      const moveDrag = (x, y) => { if(!isDragging) return; cropOffsetX += x - startX; cropOffsetY += y - startY; startX = x; startY = y; drawCropCanvas(); };
      cvs.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
      cvs.addEventListener("mousemove", e => moveDrag(e.clientX, e.clientY));
      window.addEventListener("mouseup", () => isDragging = false);
      cvs.addEventListener("touchstart", e => startDrag(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
      cvs.addEventListener("touchmove", e => { e.preventDefault(); moveDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
  }

  async function saveProfileImage() {
      const compressed = document.getElementById("crop-canvas").toDataURL('image/jpeg', 0.7);
      await fetch(API_URL + "/update-profile-img", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ id: myId, image: compressed }) });
      myProfileImg = compressed; localStorage.setItem("myProfileImg", myProfileImg); updateMyInfoUI(); closeModal("profileEditModal");
  }

  function openDeleteProfileConfirm() {
      showCustomConfirm("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒì•„ê°ˆê¹Œìš”?", async () => {
          await fetch(API_URL + "/update-profile-img", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ id: myId, image: null }) });
          myProfileImg = ""; localStorage.setItem("myProfileImg", ""); updateMyInfoUI(); closeModal("profileEditModal");
      });
  }
  
  document.getElementById("msg-input").addEventListener("keydown", e => { if(e.key==="Enter") sendMsg(); });
  function toggleStatusEditor() { const el = document.getElementById("status-edit-area"); el.style.display = (el.style.display === "none") ? "block" : "none"; }
  async function saveStatus() {
    const ns = document.getElementById("new-status-input").value; if(!ns) return;
    await fetch(API_URL + "/update-status", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({id: myId, status: ns}) });
    myStatus = ns; localStorage.setItem("myStatus", ns); updateMyInfoUI(); toggleStatusEditor();
  }

  function openClearHistoryConfirm() {
      showCustomConfirm("ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => {
          myChatRooms = []; localStorage.setItem("myChatRooms", "[]"); renderChatList();
      });
  }

  function exportChat() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myChatRooms)); const node = document.createElement("a"); node.setAttribute("href", dataStr); node.setAttribute("download", "chat_backup.json"); node.click(); }
  function importChat() { document.getElementById("file-input").click(); }
  function handleFileImport(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => { 
        try { 
            myChatRooms = JSON.parse(e.target.result); 
            localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms)); 
            renderChatList(); 
            showCustomAlert("ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(err) { 
            showCustomAlert("ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤."); 
        } 
    };
    reader.readAsText(file); input.value = "";
  }
  
  function renderFriends() {
    const c = document.getElementById("friends-list-container"); c.innerHTML = "";
    friendList.forEach(f => {
      const div = document.createElement("div"); div.className = "list-item"; div.onclick = () => startPrivateChat(f.id, f.name);
      let imgHtml = f.profile_img ? `<div class="profile-thumb" style="background-image:url(${f.profile_img}); background-color:transparent;"></div>` : `<div class="profile-thumb" style="background:${getColor(f.name)}">${f.name[0]}</div>`;
      div.innerHTML = `${imgHtml}<div class="text-area"><div class="name">${f.name}</div><div class="desc">${f.status || 'ìƒíƒœë©”ì‹œì§€ ì—†ìŒ'}</div></div>`;
      c.appendChild(div);
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ í…Œë§ˆ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°

</script>
</body>
</html>
