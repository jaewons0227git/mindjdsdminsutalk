<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>MinsuTalk Beta</title>

<!-- Parse SDK -->
<script src="https://unpkg.com/parse/dist/parse.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  #chat {
    background: #fff;
    border: 1px solid #ccc;
    height: 350px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
  }

  .me {
    text-align: right;
    color: #0b57d0;
    margin: 4px 0;
  }

  .you {
    text-align: left;
    color: #1a7f37;
    margin: 4px 0;
  }

  #inputBox {
    display: flex;
    gap: 5px;
  }

  input {
    flex: 1;
    padding: 8px;
    font-size: 14px;
  }

  button {
    padding: 8px 14px;
    font-size: 14px;
    cursor: pointer;
  }
</style>
</head>

<body>

<h2>ðŸ“© Back4App ì‹¤ì‹œê°„ DM</h2>

<div id="chat"></div>

<div id="inputBox">
  <input id="msg" placeholder="ë©”ì‹œì§€ ìž…ë ¥" />
  <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<script>
/* ===============================
   ðŸ”§ Back4App ì„¤ì •
================================ */
Parse.initialize(
  "OJwaNo46f7slcN9dxPICTXgWINlwgZFyQA2klHy9", // App ID
  "ex2lk9VFdrd0hN7KPWq3ydFGsLCTq1JV3HdaFHAO"  // JavaScript Key
);
Parse.serverURL = "https://parseapi.back4app.com";

/* ===============================
   ðŸ‘¤ í…ŒìŠ¤íŠ¸ìš© ìœ ì € ì„¤ì •
   (ë‚˜ì¤‘ì— ë¡œê·¸ì¸ìœ¼ë¡œ êµì²´ ê°€ëŠ¥)
================================ */
const myId = "userA";      // ë‚˜
const targetId = "userB";  // ìƒëŒ€

/* DM ë°© ID (í•­ìƒ ë™ì¼í•˜ê²Œ) */
const roomId = [myId, targetId].sort().join("_");

/* ===============================
   ðŸ“¦ Message í´ëž˜ìŠ¤
================================ */
const Message = Parse.Object.extend("Message");

/* ===============================
   ðŸ“¥ ê¸°ì¡´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
================================ */
const chatBox = document.getElementById("chat");

const historyQuery = new Parse.Query(Message);
historyQuery.equalTo("roomId", roomId);
historyQuery.ascending("createdAt");
historyQuery.limit(50);

historyQuery.find().then(results => {
  results.forEach(showMessage);
  chatBox.scrollTop = chatBox.scrollHeight;
});

/* ===============================
   âš¡ ì‹¤ì‹œê°„ ìˆ˜ì‹  (Live Query)
================================ */
const liveQuery = new Parse.Query(Message);
liveQuery.equalTo("roomId", roomId);

liveQuery.subscribe().then(sub => {
  sub.on("create", msg => {
    showMessage(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
});

/* ===============================
   ðŸ“¤ ë©”ì‹œì§€ ì „ì†¡
================================ */
function sendMessage() {
  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text) return;

  const message = new Message();
  message.save({
    roomId: roomId,
    sender: myId,
    text: text
  });

  input.value = "";
}

/* ===============================
   ðŸ–¥ UI ì¶œë ¥
================================ */
function showMessage(msg) {
  const div = document.createElement("div");
  const sender = msg.get("sender");
  const text = msg.get("text");

  div.className = sender === myId ? "me" : "you";
  div.textContent = sender + ": " + text;

  chatBox.appendChild(div);
}
</script>

</body>
</html>
