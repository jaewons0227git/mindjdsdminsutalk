<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>mintalk</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />
<link rel="icon" type="image/png" sizes="32x32" href="https://i.postimg.cc/7YKGq6tt/Chat-GPT-Image-2025nyeon-12wol-25il-ohu-11-48-18-removebg-preview.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://i.postimg.cc/7YKGq6tt/Chat-GPT-Image-2025nyeon-12wol-25il-ohu-11-48-18-removebg-preview.png">

<style>
  /* ===== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° UI ìˆ˜ì • ===== */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  input, textarea { touch-action: auto !important; -webkit-user-select: text; user-select: text; }
  html, body { margin: 0; padding: 0; width: 100%; height: 100vh; height: 100dvh; overflow: hidden; position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background-color: #fff; font-size: 13px; color: #000; }
  .hidden { display: none !important; }

  #view-login { width: 100%; height: 100%; background-color: #fef01b; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; z-index: 9999; top: 0; left: 0; }
  .login-logo { font-size: 80px; margin-bottom: 40px; color: #3b1e1e; }
  .login-form { width: 80%; max-width: 280px; display: flex; flex-direction: column; gap: 10px; }
  .login-input { padding: 14px 20px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; background: #fff; }
  .login-btn { padding: 14px; background: #3b1e1e; color: #fff; border: none; border-radius: 50px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; height: 48px; display: flex; align-items: center; justify-content: center; }
  .login-error { color: #d93025; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
  .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #screen-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: none; }
  #main-layout { display: flex; width: 100%; height: 100%; }
  #left-side { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; border-right: 1px solid #eee; }
  
  .home-header { height: 52px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 20px; font-weight: 700; }
  .header-icons { display: flex; gap: 18px; }
  .icon { font-family: 'Material Symbols Outlined'; font-size: 26px; font-weight: 300; cursor: pointer; }
  
  .tab-content { width: 100%; height: calc(100% - 52px - 58px); overflow-y: auto; overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom); touch-action: pan-y; }
  .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; position: relative; }
  
  .profile-thumb { width: 44px; height: 44px; border-radius: 16px; background-color: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; color: rgba(0,0,0,0.5); font-size: 14px; margin-right: 12px; background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.05); }
  
  .list-item .text-area { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .list-item .name { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
  .list-item .desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .unread-badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: #ff5252; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: bold; }
  .badge-p { background: #ffeb3b; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }
  .badge-g { background: #ddd; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }

  .more-menu { padding: 20px 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
  .menu-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
  .menu-icon { font-size: 30px; color: #444; background: #f2f2f2; padding: 12px; border-radius: 50%; }
  .menu-text { font-size: 12px; }
  .my-info-card { display: flex; align-items: center; padding: 20px 16px; }

  .bottom-nav { height: calc(58px + env(safe-area-inset-bottom)); border-top: 1px solid #f1f1f1; display: flex; align-items: flex-start; justify-content: space-around; background: #fff; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); position: absolute; bottom: 0; width: 100%; z-index: 100; }
  .nav-item { display: flex; flex-direction: column; align-items: center; color: #bbb; cursor: pointer; width: 100%; }
  .nav-item.active { color: #333; }
  
  #view-chat { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #b2c7d9; z-index: 200; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), visibility 0s 0.3s; visibility: hidden; }
  #view-chat.open { transform: translateX(0); visibility: visible; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), visibility 0s 0s; }
  
  #pc-placeholder { flex: 1; background: #f9f9f9; display: none; flex-direction: column; align-items: center; justify-content: center; color: #ccc; }
  #pc-placeholder .material-symbols-outlined { font-size: 64px; margin-bottom: 10px; }

  .chat-header { height: 50px; background: rgba(255,255,255,0.95); display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; touch-action: pan-y; }
  
  .date-divider { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
  .date-divider span { background: rgba(0,0,0,0.1); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 11px; }

  .msg-row { display: flex; width: 100%; flex-shrink: 0; position: relative; }
  .msg-row.me { justify-content: flex-end; }
  .msg-row.other { justify-content: flex-start; align-items: flex-start; }

  .chat-profile-img { width: 36px; height: 36px; border-radius: 14px; margin-right: 8px; background-color: #eee; background-size: cover; background-position: center; flex-shrink: 0; cursor: pointer; display: none; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: rgba(0,0,0,0.5); }
  .msg-row.other .chat-profile-img { display: flex; }

  .msg-content { display: flex; flex-direction: column; max-width: 75%; }
  .me .msg-content { align-items: flex-end; }
  .other .msg-content { align-items: flex-start; }

  .bubble { padding: 8px 12px; font-size: 14px; border-radius: 12px; word-break: break-all; white-space: pre-wrap; width: fit-content; line-height: 1.4; position: relative; text-align: left; }
  .other .bubble { background: #fff; border-top-left-radius: 2px; color: #000; }
  .me .bubble { background: #fef01b; border-top-right-radius: 2px; color: #000; cursor: pointer; }
  
  .bubble a { color: #007bff; text-decoration: none; cursor: pointer; }
  .bubble a:hover { text-decoration: underline; }

  .link-preview { display: block; margin-top: 8px; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); max-width: 240px; text-decoration: none; color: inherit !important; cursor: pointer; }
  .link-preview img { width: 100%; height: 120px; object-fit: cover; display: block; }
  .preview-txt { padding: 10px; }
  .preview-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #000; }
  .preview-desc { font-size: 11px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  .read-container { display: flex; align-items: flex-end; }
  .me .read-container { flex-direction: row-reverse; }
  .read-count { font-size: 10px; color: #fef01b; margin: 0 4px; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.1); }
  .me .read-count { color: #555; } 
  .msg-time { font-size: 9px; color: #555; margin: 0 4px; min-width: max-content; }

  .img-msg { max-width: 200px; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
  .edit-tag { font-size: 9px; color: rgba(0,0,0,0.4); margin-top: 2px; }

  #input-area { background: #fff; padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px; display: flex; gap: 10px; align-items: center; position: relative; z-index: 10; }
  #msg-input { flex: 1; height: 38px; background: #f5f5f5; border: none; border-radius: 20px; padding: 0 16px; outline: none; pointer-events: auto; -webkit-user-select: text; user-select: text; }
  
  #send-btn { width: 38px; height: 38px; background: #fef01b; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; pointer-events: auto; }
  #send-btn:disabled { cursor: default; background: #eee; pointer-events: none; }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; }
  .modal-box { background: #fff; width: 80%; max-width: 300px; padding: 20px; border-radius: 16px; text-align: center; }
  
  /* ë©”ì‹œì§€ ë©”ë‰´ ì „ìš© ìŠ¤íƒ€ì¼ ìˆ˜ì • */
  #msgMenuModal { background: transparent; pointer-events: none; }
  #msgMenuModal .modal-box { 
    position: absolute; 
    width: 80px; 
    padding: 5px; 
    border-radius: 8px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
    pointer-events: auto; 
    border: 1px solid #eee;
  }
  #msgMenuModal .modal-btn { 
    width: 100%; 
    padding: 8px; 
    margin-top: 2px; 
    font-size: 12px; 
    border-radius: 4px; 
    font-weight: normal;
  }

  .modal-btn { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
  .bg-y { background: #fef01b; color: #3b1e1e; }
  .bg-g { background: #f2f2f2; color: #333; }
  .bg-r { background: #ff5252; color: #fff; }

  .friend-select-list { max-height: 150px; overflow-y: auto; text-align: left; margin: 10px 0; border: 1px solid #eee; padding: 5px; }
  .friend-select-item { display: flex; align-items: center; gap: 10px; padding: 5px; }
  
  /* ì´ë¯¸ì§€ í¸ì§‘ìš© Canvas ìŠ¤íƒ€ì¼ */
  .crop-container { width: 200px; height: 200px; overflow: hidden; margin: 0 auto; border: 1px solid #ddd; border-radius: 50%; position: relative; background: #000; }
  canvas#crop-canvas { cursor: move; }
  .slider-container { margin: 15px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
  input[type=range] { width: 80%; }

  @media (min-width: 768px) {
    #left-side { width: 380px; flex-shrink: 0; }
    #view-chat { position: relative; transform: none; visibility: visible; display: none; z-index: 10; flex: 1; border-left: 1px solid #ddd; }
    #view-chat.open { display: flex; }
    #pc-placeholder { display: flex; }
    #view-chat.open ~ #pc-placeholder { display: none; }
    .chat-header .material-symbols-outlined[onclick="exitRoom()"] { display: none; }
  }
                 </style>

</head>
<body>





<div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:999999; transition:opacity 0.5s ease; touch-action:none; pointer-events:all;">
    <style>
        /* ë¡œê³  í¬ê¸°ë¥¼ ëª¨ë°”ì¼ì—ì„œëŠ” ì¡°ê¸ˆ ë” ì‘ê²Œ, PCì—ì„œëŠ” ì›ë˜ëŒ€ë¡œ ì¡°ì ˆ */
        .custom-logo {
            width: 30vw; /* í™”ë©´ ë„ˆë¹„ì˜ 30% */
            max-width: 150px; /* ìµœëŒ€ 150px */
            min-width: 100px; /* ìµœì†Œ 100px */
            aspect-ratio: 1/1;
            margin-bottom: 20px;
            background: linear-gradient(270deg, #FFB7CE, #B19CD9, #FFB7CE);
            background-size: 200% 100%;
            -webkit-mask: url('https://i.postimg.cc/D0DF0t9r/image-removebg-preview.png') no-repeat center / contain;
            mask: url('https://i.postimg.cc/D0DF0t9r/image-removebg-preview.png') no-repeat center / contain;
            animation: gradMove 2.5s linear infinite;
        }

        .custom-bar-bg {
            width: 50%; /* ëª¨ë°”ì¼ì—ì„œ ì ì ˆí•œ ë„ˆë¹„ */
            max-width: 200px;
            height: 5px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .custom-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FFB7CE, #B19CD9);
            animation: loadFill 2s ease-in-out forwards;
        }

        @keyframes gradMove {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        @keyframes loadFill {
            to { width: 100%; }
        }
    </style>

    <div class="custom-logo"></div>
    <div class="custom-bar-bg">
        <div class="custom-bar-fill"></div>
    </div>

    <script>
        window.addEventListener('load', function() {
            const loader = document.getElementById('loading-overlay');
            // ëª¨ë°”ì¼ ë„¤íŠ¸ì›Œí¬ ì†ë„ë¥¼ ê³ ë ¤í•˜ì—¬ ë„‰ë„‰íˆ 2.5ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            }, 6500);
        });
    </script>
</div>




<div id="view-login">
  <span class="material-symbols-outlined login-logo">chat_bubble</span>
  <div class="login-form">
    <input id="login-id" class="login-input" placeholder="ì•„ì´ë””" autocomplete="off">
    <input id="login-pw" type="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="login-btn" onclick="handleLogin()">
      <span id="btn-text">ë¡œê·¸ì¸</span>
      <span id="btn-loader" class="loader hidden"></span>
    </button>
    <div id="login-msg" class="login-error"></div>
  </div>
</div>

<div id="screen-container">
  <div id="main-layout">
    <div id="left-side">
      <div id="view-home" style="width:100%; height:100%; display:flex; flex-direction:column;">
        <div class="home-header">
          <span id="header-title">ì¹œêµ¬</span>
          <div class="header-icons">
            <span class="icon" onclick="openCreateChatModal()">add_circle</span>
            <span class="icon">search</span>
          </div>
        </div>

        <div id="tab-friends" class="tab-content">
          <div class="my-info-card">
            <div class="profile-thumb" id="my-profile-img">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" id="my-name-display" style="font-size:16px;">ë‚˜</div>
              <div class="desc" id="my-status-display">ìƒíƒœë©”ì‹œì§€ ì…ë ¥ í•„ìš”</div>
            </div>
          </div>
          <hr style="border:0; border-top:1px solid #f5f5f5; margin:0 0 10px 0;">
          <div id="friends-list-container"></div>
        </div>

        <div id="tab-chats" class="tab-content hidden">
          <div id="chat-list-container"></div>
        </div>

        <div id="tab-more" class="tab-content hidden">
          <div class="my-info-card">
            <div class="profile-thumb" id="more-profile-img" style="cursor:pointer;" onclick="openProfileEdit()">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" style="font-size:18px; margin-bottom:5px;">ë”ë³´ê¸°</div>
              <div class="desc" id="more-email-display">user@email.com</div>
              <div class="desc" style="font-size:11px; color:#aaa; margin-top:2px;">ì‚¬ì§„ì„ ëˆŒëŸ¬ í”„ë¡œí•„ ë³€ê²½</div>
            </div>
          </div>
          <div class="status-editor" id="status-edit-area" style="padding: 0 16px; display: none;">
            <input id="new-status-input" class="login-input" style="width:100%; border-radius:8px; margin-bottom:8px;" placeholder="ìƒˆ ìƒíƒœë©”ì‹œì§€ ì…ë ¥">
            <div style="display:flex; gap:8px;">
              <button class="modal-btn bg-y" style="margin:0;" onclick="saveStatus()">ì €ì¥</button>
              <button class="modal-btn bg-g" style="margin:0;" onclick="toggleStatusEditor()">ì·¨ì†Œ</button>
            </div>
          </div>
          <div class="more-menu">
            <div class="menu-btn" onclick="toggleStatusEditor()"><span class="material-symbols-outlined menu-icon">edit_note</span><span class="menu-text">ìƒíƒœë³€ê²½</span></div>
            <div class="menu-btn" onclick="clearRoomHistory()"><span class="material-symbols-outlined menu-icon">delete_sweep</span><span class="menu-text">ê¸°ë¡ì‚­ì œ</span></div>
            <div class="menu-btn" onclick="exportChat()"><span class="material-symbols-outlined menu-icon">download</span><span class="menu-text">ë‚´ë³´ë‚´ê¸°</span></div>
            <div class="menu-btn" onclick="importChat()"><span class="material-symbols-outlined menu-icon">upload</span><span class="menu-text">ê°€ì ¸ì˜¤ê¸°</span></div>
            <div class="menu-btn" onclick="logout()"><span class="material-symbols-outlined menu-icon" style="color:#d93025; background:#ffebeb;">logout</span><span class="menu-text" style="color:#d93025;">ë¡œê·¸ì•„ì›ƒ</span></div>
          </div>
        </div>

        <div class="bottom-nav">
          <div class="nav-item active" onclick="switchTab('friends', this)"><span class="material-symbols-outlined" style="font-size:26px;">person</span></div>
          <div class="nav-item" onclick="switchTab('chats', this)"><span class="material-symbols-outlined" style="font-size:24px;">chat_bubble</span></div>
          <div class="nav-item" onclick="switchTab('more', this)"><span class="material-symbols-outlined" style="font-size:28px;">more_horiz</span></div>
        </div>
      </div>
    </div>

    <div id="view-chat">
      <header class="chat-header">
        <span class="material-symbols-outlined" style="font-size:24px; padding:10px; cursor:pointer;" onclick="exitRoom()">arrow_back</span>
        <div style="flex:1; font-weight:700; font-size:16px;" id="room-title">ì±„íŒ…ë°©</div>
        <span class="material-symbols-outlined" style="cursor:pointer; padding:10px;" onclick="openChatMenu()">menu</span>
      </header>
      <div id="chat-msgs" class="chat-msgs"></div>
      <div id="input-area">
        <input type="file" id="img-input" class="hidden" accept="image/*" onchange="sendImage(this)">
        <span class="material-symbols-outlined" style="color:#bbb; cursor:pointer;" onclick="document.getElementById('img-input').click()">add</span>
        <input id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off">
        <button id="send-btn" onclick="sendMsg()">
          <span id="send-icon" class="material-symbols-outlined" style="font-size:20px;">arrow_upward</span>
          <span id="send-loader" class="loader hidden" style="border-color:#333; border-bottom-color:transparent; width:16px; height:16px; border-width:2px;"></span>
        </button>
      </div>
    </div>

    <div id="pc-placeholder">
      <span class="material-symbols-outlined">chat_bubble</span>
      <p>ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
    </div>
  </div>
</div>

<div id="createChatModal" class="modal">
  <div class="modal-box">
    <h3>ìƒˆë¡œìš´ ì±„íŒ…</h3>
    <input id="new-room-name" class="login-input" style="width:100%; margin-top:10px; border-radius:10px;" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ê°€ì¡±ë°©)">
    <div class="friend-select-list" id="friend-select-container"></div>
    <button class="modal-btn bg-y" onclick="createGroupChat()">ë§Œë“¤ê¸°</button>
    <button class="modal-btn bg-g" onclick="closeModal('createChatModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="chatMenuModal" class="modal">
  <div class="modal-box">
    <h3 id="menu-room-name">ì±„íŒ…ë°© ì„¤ì •</h3>
    <button class="modal-btn bg-g" onclick="leaveRoomLocal()">ì±„íŒ…ë°© ë‚˜ê°€ê¸° (ë‚˜ë§Œ)</button>
    <button class="modal-btn bg-r" id="del-room-btn" onclick="deleteRoomGlobal()">ì±„íŒ…ë°© ì‚­ì œ (ëª¨ë‘ì—ê²Œì„œ)</button>
    <button class="modal-btn bg-g" onclick="closeModal('chatMenuModal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="msgMenuModal" class="modal">
  <div class="modal-box">
    <button id="edit-btn-modal" class="modal-btn bg-y" onclick="promptEditMsg()">ìˆ˜ì •</button>
    <button class="modal-btn bg-r" onclick="deleteMsgServer()">ì‚­ì œ</button>
    <button class="modal-btn bg-g" onclick="closeModal('msgMenuModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="profileEditModal" class="modal">
  <div class="modal-box">
    <h3>í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</h3>
    <div class="crop-container">
        <canvas id="crop-canvas" width="200" height="200"></canvas>
    </div>
    <div class="slider-container">
        <span class="material-symbols-outlined" style="font-size:16px;">remove</span>
        <input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" oninput="handleImageZoom(this.value)">
        <span class="material-symbols-outlined" style="font-size:16px;">add</span>
    </div>
    
    <button class="modal-btn bg-y" onclick="document.getElementById('profile-file-input').click()">ì‚¬ì§„ ì„ íƒ</button>
    <button class="modal-btn bg-y" onclick="saveProfileImage()">ì €ì¥</button>
    <button class="modal-btn bg-g" onclick="deleteProfileImage()">ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½</button>
    <button class="modal-btn bg-g" style="margin-top:15px; border-top:1px solid #eee;" onclick="closeModal('profileEditModal')">ë‹«ê¸°</button>
  </div>
</div>

<input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport(this)">
<input type="file" id="profile-file-input" class="hidden" accept="image/*" onchange="handleProfileSelect(this)">

<script>
  const API_URL = "https://jaewondev3.pythonanywhere.com";
  
  let myId = localStorage.getItem("myId");
  let myName = localStorage.getItem("myName");
  let myStatus = localStorage.getItem("myStatus") || "";
  let myProfileImg = localStorage.getItem("myProfileImg") || ""; 
  let friendList = JSON.parse(localStorage.getItem("friendList") || "[]");
  let myChatRooms = JSON.parse(localStorage.getItem("myChatRooms") || "[]");
  let allMessagesCache = {}; // [ì¶”ê°€] ì „ì²´ ë©”ì‹œì§€ ìºì‹œ
  let currentRoomId = null;
  let chatPollInterval = null;
  let listPollInterval = null;
  let selectedMsgId = null;

  // í¸ì§‘ìš© ë³€ìˆ˜
  let cropImg = new Image();
  let cropScale = 1;
  let cropOffsetX = 0;
  let cropOffsetY = 0;
  let isDragging = false;
  let startX, startY;

  const pastelColors = ["#FFB7B2", "#FFDAC1", "#E2F0CB", "#B5EAD7", "#C7CEEA", "#e4c1f9"];
  function getColor(s) { return pastelColors[(s || "").length % pastelColors.length]; }

  if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
  }

  if (myId) initApp();

  async function handleLogin() {
    const id = document.getElementById("login-id").value;
    const pw = document.getElementById("login-pw").value;
    const btnText = document.getElementById("btn-text");
    const loader = document.getElementById("btn-loader");
    const msgBox = document.getElementById("login-msg");
    btnText.classList.add("hidden"); loader.classList.remove("hidden"); msgBox.style.display = "none";
    try {
      const res = await fetch(API_URL + "/login", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id, password:pw})
      });
      const data = await res.json();
      if(data.success) {
        myId = data.id; myName = data.name; myStatus = data.status; 
        friendList = data.friendList;
        myProfileImg = data.profile_img || "";

        localStorage.setItem("myId", myId); localStorage.setItem("myName", myName);
        localStorage.setItem("myStatus", myStatus); 
        localStorage.setItem("friendList", JSON.stringify(friendList));
        localStorage.setItem("myProfileImg", myProfileImg);

        if ("Notification" in window) Notification.requestPermission();
        initApp();
      } else { throw new Error(data.message); }
    } catch(err) {
      msgBox.innerText = err.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨"; msgBox.style.display = "block";
      btnText.classList.remove("hidden"); loader.classList.add("hidden");
    }
  }

  function initApp() {
    document.getElementById("view-login").style.display = "none";
    document.getElementById("screen-container").style.display = "block";
    updateMyInfoUI(); renderFriends(); renderChatList();
    
    // [ì¶”ê°€] ë¡œê·¸ì¸ ì§í›„ ëª¨ë“  ëŒ€í™”ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetchAllMessages();

    // ë£¸ ë™ê¸°í™” ë° ì¹œêµ¬ ëª©ë¡ ë™ê¸°í™”
    listPollInterval = setInterval(() => {
        syncRoomsFromServer();
        syncFriends();
    }, 2000);
    
    initCanvasEvents();
    
    // ìˆ˜ì •/ì‚­ì œ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
    window.addEventListener('mousedown', (e) => {
      const modal = document.getElementById('msgMenuModal');
      const box = modal.querySelector('.modal-box');
      if(modal.style.display === 'flex' && !box.contains(e.target)) {
        closeModal('msgMenuModal');
      }
    });
  }

  // [ì¶”ê°€] ëª¨ë“  ë©”ì‹œì§€ í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¤ê¸°
  async function fetchAllMessages() {
      try {
          const res = await fetch(`${API_URL}/get-all-messages?id=${myId}`);
          const data = await res.json();
          allMessagesCache = data; // ìºì‹œ ì €ì¥
          if(currentRoomId) renderMsgs(allMessagesCache[currentRoomId] || []);
      } catch(e) {}
  }

  function sendPushNotification(title, body) {
    if (Notification.permission === "granted") {
      new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png' });
    }
  }

  async function syncRoomsFromServer() {
    try {
      const res = await fetch(`${API_URL}/my-rooms?name=${myName}&id=${myId}`);
      const serverRooms = await res.json();
      let changed = false;
      serverRooms.forEach(sr => {
        const local = myChatRooms.find(r => r.id === sr.id);
        if(!local) {
          let title = sr.id.startsWith('private') ? sr.id.replace('private_','').replace(myId,'').replace('_','') : sr.id.replace('group_','');
          if(sr.id.startsWith('private')) {
            const f = friendList.find(fr => sr.id.includes(fr.id));
            if(f) title = f.name;
          }
          myChatRooms.unshift({ id: sr.id, title, type: sr.id.split('_')[0], lastMsg: sr.lastMsg, lastReadCount: 0, creator: sr.creator, messages_count: sr.messages_count, lastSender: sr.lastSender });
          changed = true;
          if(sr.creator !== myName) sendPushNotification("ìƒˆ ì±„íŒ…ë°©", `${title} ë°©ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          if(local.messages_count !== sr.messages_count) {
             // [ìˆ˜ì •] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ ë•Œë§Œ ì•Œë¦¼ ë°œìƒ
             if(sr.messages_count > (local.messages_count || 0)) {
               if(sr.lastSender !== myName) {
                   if(currentRoomId !== sr.id || document.hidden) {
                      sendPushNotification(local.title, sr.lastMsg || "ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
                   }
               }
            }
            local.messages_count = sr.messages_count;
            local.lastMsg = sr.lastMsg;
            local.lastSender = sr.lastSender;
            changed = true;
            // [ì¶”ê°€] ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œ ê°œë³„ ë°© ë©”ì‹œì§€ë„ ìºì‹œì— ì¶”ê°€í•˜ê¸° ìœ„í•´ ë¡œë“œ
            if(currentRoomId === sr.id) loadMsgs();
          }
        }
      });
      if(changed) {
        localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
        renderChatList();
      }
    } catch(e) {}
  }

  // [ì‹ ê·œ] ì¹œêµ¬ ëª©ë¡(í”„ì‚¬ í¬í•¨) ë™ê¸°í™” í•¨ìˆ˜
  async function syncFriends() {
      try {
          const res = await fetch(`${API_URL}/get-friend-list?id=${myId}`);
          const newList = await res.json();
          // ë³€ê²½ì‚¬í•­ í™•ì¸ (ë‹¨ìˆœí™”: JSON ë¬¸ìì—´ ë¹„êµ)
          if(JSON.stringify(friendList) !== JSON.stringify(newList)) {
              friendList = newList;
              localStorage.setItem("friendList", JSON.stringify(friendList));
              renderFriends(); // ì¹œêµ¬ëª©ë¡ ê°±ì‹ 
              renderChatList(); // ì±„íŒ…ëª©ë¡ í”„ì‚¬ ê°±ì‹ 
              if(currentRoomId) loadMsgs(); // ì±„íŒ…ì°½ ë‚´ë¶€ í”„ì‚¬ ê°±ì‹ 
          }
      } catch(e) {}
  }

  function setProfileImg(elId, imgData, fallbackName) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (imgData) {
        el.innerText = "";
        el.style.backgroundImage = `url(${imgData})`;
        el.style.backgroundColor = "transparent";
    } else {
        el.style.backgroundImage = "none";
        el.innerText = fallbackName ? fallbackName[0] : "?";
        el.style.backgroundColor = fallbackName ? getColor(fallbackName) : "#eee";
    }
  }

  function updateMyInfoUI() {
    document.getElementById("my-name-display").innerText = myName;
    document.getElementById("my-status-display").innerText = myStatus || "ìƒíƒœë©”ì‹œì§€ ì—†ìŒ";
    document.getElementById("more-email-display").innerText = myId + "@mintalk.kro.kr";
    
    setProfileImg("my-profile-img", myProfileImg, myName);
    setProfileImg("more-profile-img", myProfileImg, myName);
  }

  function logout() { localStorage.clear(); location.reload(); }

  function switchTab(tab, el) {
    document.querySelectorAll(".nav-item").forEach(e => e.classList.remove("active"));
    el.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(e => e.classList.add("hidden"));
    document.getElementById(`tab-${tab}`).classList.remove("hidden");
    const titles = { friends: "ì¹œêµ¬", chats: "ì±„íŒ…", more: "ë”ë³´ê¸°" };
    document.getElementById("header-title").innerText = titles[tab];
    if(tab === 'chats') renderChatList();
  }

  function enterRoom(id, title, type) {
    // 1. ê¸°ì¡´ì— ëŒê³  ìˆë˜ ì¸í„°ë²Œ(ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°)ì„ ì¦‰ì‹œ ì¢…ë£Œ
    if(chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }

    // 2. ì±„íŒ…ë°© ì •ë³´ ì„¤ì •
    const room = myChatRooms.find(r => r.id === id);
    if (!room) {
      myChatRooms.unshift({ id, title, type, lastMsg: "ìƒˆ ëŒ€í™”", lastReadCount: 0 });
    } else {
      room.lastReadCount = room.messages_count || 0;
    }
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    
    // 3. í˜„ì¬ ë°© ID ë³€ê²½ ë° UI ì—…ë°ì´íŠ¸
    currentRoomId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("view-chat").classList.add("open");
    
    // 4. í™”ë©´ ì´ˆê¸°í™” ë° ìºì‹œ ë°ì´í„° ì¦‰ì‹œ ë Œë”ë§
    // (ì´ì „ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ ë¨¼ì € ë¹„ì›ë‹ˆë‹¤)
    document.getElementById("chat-msgs").innerHTML = ""; 
    
    if(allMessagesCache[id]) {
        renderMsgs(allMessagesCache[id]);
    }

    // 5. ì„œë²„ì—ì„œ ìµœì‹  ë©”ì‹œì§€ í•œ ë²ˆ ê°€ì ¸ì˜¤ê³  1ì´ˆë§ˆë‹¤ ë°˜ë³µ ì‹œì‘
    loadMsgs();
    chatPollInterval = setInterval(loadMsgs, 1000);
  }

  function exitRoom() {
    const chatView = document.getElementById("view-chat");
    // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ (CSS transition í™œìš©)
    chatView.classList.remove("open");
    
    // ì¸í„°ë²Œ ì¢…ë£Œ
    if(chatPollInterval) {
        clearInterval(chatPollInterval);
        chatPollInterval = null;
    }
    currentRoomId = null;
    
    // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(0.3ì´ˆ) í›„ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
    setTimeout(renderChatList, 300);
  }

  function renderChatList() {
    const container = document.getElementById("chat-list-container");
    container.innerHTML = "";
    if(myChatRooms.length === 0) {
      container.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>ì§„í–‰ ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    myChatRooms.forEach(room => {
      const isPrivate = room.type === 'private';
      const iconChar = isPrivate ? (room.title ? room.title[0] : '?') : 'ğŸ“¢';
      
      let roomImg = null;
      if(isPrivate) {
         const friend = friendList.find(f => room.id.includes(f.id));
         if(friend && friend.profile_img) roomImg = friend.profile_img;
      }

      const badge = isPrivate ? `<span class="badge-p">1:1</span>` : `<span class="badge-g">ë‹¨ì²´</span>`;
      
      // [ìˆ˜ì •] ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ë§ˆì§€ë§‰ì¸ ê²½ìš° ë°°ì§€ 0ìœ¼ë¡œ í‘œì‹œ (ìƒëŒ€ë°©ì´ ë³´ë‚¸ ê²ƒë§Œ ì¹´ìš´íŠ¸)
      let unreadCount = (room.messages_count || 0) - (room.lastReadCount || 0);
      if(room.lastSender === myName) unreadCount = 0; 
      
      const unreadHtml = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : "";

      const div = document.createElement("div");
      div.className = "list-item";
      div.onclick = () => enterRoom(room.id, room.title, room.type);
      
      let imgHtml = `<div class="profile-thumb" style="background:${getColor(room.title||"")}">${iconChar}</div>`;
      if(roomImg) {
        imgHtml = `<div class="profile-thumb" style="background-image:url(${roomImg}); background-color:transparent;"></div>`;
      }

      div.innerHTML = `
        ${imgHtml}
        <div class="text-area">
          <div class="name">${room.title}</div>
          <div class="desc">${badge} ${room.lastMsg || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ'}</div>
        </div>
        ${unreadHtml}
      `;
      container.appendChild(div);
    });
  }

  async function loadMsgs() {
    if(!currentRoomId) return;
    const initialRoomId = currentRoomId; // [ìˆ˜ì •] ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì „ ë°© ID ì €ì¥
    try {
      const res = await fetch(`${API_URL}/messages?room=${currentRoomId}`);
      const msgs = await res.json();
      
      // [ìˆ˜ì •] ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ í˜„ì¬ ë°© IDê°€ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸ (ë‹¤ë¥´ë©´ ë Œë”ë§ ë¬´ì‹œ)
      if(initialRoomId !== currentRoomId) return;

      allMessagesCache[currentRoomId] = msgs;

      await fetch(`${API_URL}/mark-read`, {
          method: "POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ room: currentRoomId, id: myId })
      });

      renderMsgs(msgs);
      const room = myChatRooms.find(r => r.id === currentRoomId);
      if(room) { room.messages_count = msgs.length; room.lastReadCount = msgs.length; }
    } catch(e) {}
  }

  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
      return `<a href="${url}" target="_blank">${url}</a>`;
    });
  }

  // [ì¶”ê°€] íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í•œêµ­ ë‚ ì§œ ë¬¸ìì—´ë¡œ ë³€í™˜ (yyyyë…„ mì›” dì¼ ìš”ì¼)
  function formatDate(ts) {
      const date = new Date(parseFloat(ts) * 1000);
      return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
  }

  function renderMsgs(msgs) {
    const box = document.getElementById("chat-msgs");
    const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
    
    box.innerHTML = "";
    let lastDate = "";

    msgs.forEach(m => {
      // [ì¶”ê°€] ë‚ ì§œ êµ¬ë¶„ì„  ë¡œì§
      const currentDate = formatDate(m.id);
      if(currentDate !== lastDate) {
          const dateDiv = document.createElement("div");
          dateDiv.className = "date-divider";
          dateDiv.innerHTML = `<span>${currentDate}</span>`;
          box.appendChild(dateDiv);
          lastDate = currentDate;
      }

      const isMe = m.name === myName;
      const div = document.createElement("div");
      div.className = `msg-row ${isMe ? 'me' : 'other'}`;
      
      let senderImg = "";
      if(!isMe) {
          const friend = friendList.find(f => f.name === m.name);
          if(friend && friend.profile_img) senderImg = `background-image:url(${friend.profile_img}); background-color:transparent;`;
          else senderImg = `background-color:${getColor(m.name)}`;
      }

      let readCountDisplay = "";
      if (m.read_by && isMe) {
          if (m.read_by.length < 2) readCountDisplay = "1";
      }

      let contentHtml = "";
      if (m.image) {
          contentHtml = `<img src="${m.image}" class="img-msg" onclick="${isMe ? `openMsgMenu(event, '${m.id}', true)` : ''}">`;
      } else {
          contentHtml = `<div class="bubble" onclick="${isMe ? `openMsgMenu(event, '${m.id}', false)` : ''}">${linkify(m.msg)}</div>`;
      }
      
      if(m.preview) {
          contentHtml += `
            <a href="${m.preview.url}" target="_blank" class="link-preview">
                ${m.preview.image ? `<img src="${m.preview.image}">` : ''}
                <div class="preview-txt">
                    <div class="preview-title">${m.preview.title}</div>
                    <div class="preview-desc">${m.preview.description}</div>
                </div>
            </a>
          `;
      }

      if(m.edited) contentHtml += `<span class="edit-tag">ìˆ˜ì •ë¨</span>`;

      div.innerHTML = `
        ${!isMe ? `<div class="chat-profile-img" style="${senderImg}">${senderImg.includes('url')?'':m.name[0]}</div>` : ''}
        <div class="msg-content">
          ${!isMe ? `<span style="font-size:11px; margin-bottom:4px; margin-left:2px; color:#666;">${m.name}</span>` : ''}
          <div class="read-container">
             ${contentHtml}
             <div style="display:flex; flex-direction:column; justify-content:flex-end;">
                <span class="read-count">${readCountDisplay}</span>
                <span class="msg-time">${m.time}</span>
             </div>
          </div>
        </div>
      `;
      box.appendChild(div);
    });
    if(isAtBottom) box.scrollTop = box.scrollHeight;
  }

  async function sendMsg() {
    const input = document.getElementById("msg-input");
    const btn = document.getElementById("send-btn");
    const icon = document.getElementById("send-icon");
    const loader = document.getElementById("send-loader");
    const msg = input.value.trim();
    if(!msg) return;

    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");

    try {
      await fetch(API_URL + "/send", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ room: currentRoomId, name: myName, msg: msg })
      });
      input.value = ""; 
      loadMsgs();
    } finally {
      btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden");
      input.focus();
    }
  }

  async function sendImage(input) {
    const file = input.files[0];
    const btn = document.getElementById("send-btn");
    const icon = document.getElementById("send-icon");
    const loader = document.getElementById("send-loader");
    if(!file) return;

    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = async function() {
        const canvas = document.createElement('canvas');
        let width = img.width, height = img.height, max_size = 800;
        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } } 
        else { if (height > max_size) { width *= max_size / height; height = max_size; } }
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        
        try {
          await fetch(API_URL + "/send", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ room: currentRoomId, name: myName, image: compressedBase64, msg: "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤." })
          });
          loadMsgs();
        } finally {
          btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden");
        }
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = "";
  }

  function openMsgMenu(e, id, isImage) {
    selectedMsgId = id;
    const modal = document.getElementById("msgMenuModal");
    const box = modal.querySelector('.modal-box');
    
    document.getElementById("edit-btn-modal").style.display = isImage ? "none" : "block";
    
    // ìœ„ì¹˜ ì„¤ì •: í´ë¦­í•œ ì¢Œí‘œ ê·¼ì²˜ì— ë„ìš°ê¸° (ì‘ì€ íŒì—…)
    modal.style.display = "flex";
    
    let x = e.clientX;
    let y = e.clientY;
    
    // í™”ë©´ ìš°ì¸¡/í•˜ë‹¨ ë„˜ì¹¨ ë°©ì§€
    if (x + 90 > window.innerWidth) x -= 90;
    if (y + 100 > window.innerHeight) y -= 100;
    
    box.style.left = x + "px";
    box.style.top = y + "px";
  }

  async function deleteMsgServer() {
    if(!confirm("ì´ ë©”ì‹œì§€(ë˜ëŠ” ì‚¬ì§„)ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
    await fetch(API_URL + "/delete-msg", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId })
    });
    closeModal('msgMenuModal'); loadMsgs();
  }

  async function promptEditMsg() {
    const newMsg = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if(!newMsg) return;
    await fetch(API_URL + "/edit-msg", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId, msg: newMsg })
    });
    closeModal('msgMenuModal'); loadMsgs();
  }

  function openChatMenu() {
    const room = myChatRooms.find(r => r.id === currentRoomId);
    document.getElementById("menu-room-name").innerText = room.title;
    document.getElementById("del-room-btn").style.display = (room.type === 'group') ? "block" : "none";
    document.getElementById("chatMenuModal").style.display = "flex";
  }

  function leaveRoomLocal() {
    if(!confirm("ë¦¬ìŠ¤íŠ¸ì—ì„œ ì´ ì±„íŒ…ë°©ì„ ì—†ì•¨ê¹Œìš”?")) return;
    myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId);
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    closeModal('chatMenuModal'); exitRoom();
  }

  async function deleteRoomGlobal() {
    if(!confirm("ì´ ì±„íŒ…ë°©ì˜ ëª¨ë“  ëŒ€í™”ë‚´ìš©ì„ ì‚­ì œí•˜ê³  ë°©ì„ ì—†ì•¨ê¹Œìš”?")) return;
    await fetch(API_URL + "/delete-room", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId })
    });
    myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId);
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    closeModal('chatMenuModal'); exitRoom();
  }

  function openCreateChatModal() {
    const container = document.getElementById("friend-select-container");
    container.innerHTML = "";
    friendList.forEach(f => {
      container.innerHTML += `
        <div class="friend-select-item">
          <input type="checkbox" name="invited-friend" value="${f.name}" id="chk-${f.id}">
          <label for="chk-${f.id}">${f.name}</label>
        </div>`;
    });
    document.getElementById("createChatModal").style.display = "flex";
  }

  function createGroupChat() {
    const name = document.getElementById("new-room-name").value.trim();
    const checked = document.querySelectorAll('input[name="invited-friend"]:checked');
    if(!name) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    let participants = [myName];
    checked.forEach(c => participants.push(c.value));
    const roomId = `group_${Date.now()}`;
    enterRoom(roomId, name, 'group');
    fetch(API_URL + "/send", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: roomId, name: "System", msg: `${myName}ë‹˜ì´ ë°©ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`, participants: participants })
    });
    closeModal('createChatModal');
  }

  function startPrivateChat(friendId, friendName) {
    const sorted = [myId, friendId].sort();
    const roomId = `private_${sorted[0]}_${sorted[1]}`;
    enterRoom(roomId, friendName, 'private');
  }

  // --- í”„ë¡œí•„ ì‚¬ì§„ Canvas í¸ì§‘ ë¡œì§ ---
  function openProfileEdit() {
      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      const cvs = document.getElementById("crop-canvas");
      const ctx = cvs.getContext("2d");
      ctx.clearRect(0, 0, cvs.width, cvs.height);
      ctx.fillStyle = "#eee";
      ctx.fillRect(0,0, cvs.width, cvs.height);
      
      // ë‚´ í˜„ì¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¡œë“œ
      if(myProfileImg) {
          cropImg.src = myProfileImg;
          cropImg.onload = () => {
              cropScale = 1; cropOffsetX = 0; cropOffsetY = 0;
              document.getElementById("zoom-slider").value = 1;
              drawCropCanvas();
          }
      }
      document.getElementById("profileEditModal").style.display = "flex";
  }

function handleProfileSelect(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        cropImg = new Image();
        cropImg.onload = function() {
            const cvs = document.getElementById("crop-canvas");
            const scaleX = cvs.width / cropImg.width;
            const scaleY = cvs.height / cropImg.height;
            const baseScale = Math.max(scaleX, scaleY); 
            cropScale = baseScale; 
            cropOffsetX = 0; 
            cropOffsetY = 0;
            const slider = document.getElementById("zoom-slider");
            slider.min = baseScale * 0.5;
            slider.max = baseScale * 5;
            slider.value = baseScale;
            drawCropCanvas();
        }
        cropImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = "";
}

function drawCropCanvas() {
    const cvs = document.getElementById("crop-canvas");
    const ctx = cvs.getContext("2d");
    if (!cropImg.src) return;
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    const sWidth = cropImg.width * cropScale;
    const sHeight = cropImg.height * cropScale;
    const x = (cvs.width - sWidth) / 2 + cropOffsetX;
    const y = (cvs.height - sHeight) / 2 + cropOffsetY;
    ctx.drawImage(cropImg, x, y, sWidth, sHeight);
}

  function handleImageZoom(val) {
      cropScale = parseFloat(val);
      drawCropCanvas();
  }

  function initCanvasEvents() {
      const cvs = document.getElementById("crop-canvas");
      const startDrag = (x, y) => { isDragging = true; startX = x; startY = y; };
      const moveDrag = (x, y) => {
          if(!isDragging) return;
          cropOffsetX += x - startX;
          cropOffsetY += y - startY;
          startX = x; startY = y;
          drawCropCanvas();
      };
      const endDrag = () => { isDragging = false; };
      cvs.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
      cvs.addEventListener("mousemove", e => moveDrag(e.clientX, e.clientY));
      window.addEventListener("mouseup", endDrag);
      cvs.addEventListener("touchstart", e => startDrag(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
      cvs.addEventListener("touchmove", e => { e.preventDefault(); moveDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
      window.addEventListener("touchend", endDrag);
  }

  async function saveProfileImage() {
      const cvs = document.getElementById("crop-canvas");
      const compressedBase64 = cvs.toDataURL('image/jpeg', 0.7);
      await fetch(API_URL + "/update-profile-img", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ id: myId, image: compressedBase64 })
      });
      myProfileImg = compressedBase64;
      localStorage.setItem("myProfileImg", myProfileImg);
      updateMyInfoUI();
      closeModal("profileEditModal");
  }

  async function deleteProfileImage() {
      if(!confirm("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒì•„ê°ˆê¹Œìš”?")) return;
      await fetch(API_URL + "/update-profile-img", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ id: myId, image: null })
      });
      myProfileImg = "";
      localStorage.setItem("myProfileImg", "");
      updateMyInfoUI();
      closeModal("profileEditModal");
  }
  
  document.getElementById("msg-input").addEventListener("keydown", e=>{ if(e.key==="Enter") sendMsg(); });
  function toggleStatusEditor() { const el = document.getElementById("status-edit-area"); el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none"; }
  async function saveStatus() {
    const newStat = document.getElementById("new-status-input").value;
    if(!newStat) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    await fetch(API_URL + "/update-status", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({id: myId, status: newStat}) });
    myStatus = newStat; localStorage.setItem("myStatus", newStat);
    updateMyInfoUI(); toggleStatusEditor(); alert("ìƒíƒœë©”ì‹œì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  function clearRoomHistory() { if(confirm("ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { myChatRooms = []; localStorage.setItem("myChatRooms", "[]"); renderChatList(); } }
  function exportChat() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myChatRooms)); const node = document.createElement("a"); node.setAttribute("href", dataStr); node.setAttribute("download", "chat_backup.json"); document.body.appendChild(node); node.click(); node.remove(); }
  function importChat() { document.getElementById("file-input").click(); }
  function handleFileImport(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try { const imported = JSON.parse(e.target.result); myChatRooms = imported; localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms)); alert("ë³µì› ì™„ë£Œ!"); renderChatList(); } catch(err) { alert("ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤."); }
    };
    reader.readAsText(file); input.value = "";
  }
  
  function renderFriends() {
    const c = document.getElementById("friends-list-container");
    c.innerHTML = "";
    friendList.forEach(f => {
      const div = document.createElement("div"); div.className = "list-item";
      div.onclick = () => startPrivateChat(f.id, f.name);
      let imgHtml = `<div class="profile-thumb" style="background:${getColor(f.name)}">${f.name[0]}</div>`;
      if(f.profile_img) {
          imgHtml = `<div class="profile-thumb" style="background-image:url(${f.profile_img}); background-color:transparent;"></div>`;
      }
      div.innerHTML = `
        ${imgHtml}
        <div class="text-area"><div class="name">${f.name}</div><div class="desc">${f.status || 'ìƒíƒœë©”ì‹œì§€ ì—†ìŒ'}</div></div>
      `;
      c.appendChild(div);
    });
  }
  function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
