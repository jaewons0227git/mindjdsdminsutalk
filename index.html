<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>mintalk</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

<style>
  /* ===== Reset & Base ===== */
  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë° ë¶ˆí•„ìš”í•œ í„°ì¹˜ ì œìŠ¤ì²˜ ë°©ì§€ */
    touch-action: manipulation; 
  }
  
  html, body {
    margin: 0; padding: 0;
    width: 100%;
    /* 100dvhë¡œ ë¸Œë¼ìš°ì € íˆ´ë°” ëŒ€ì‘ */
    height: 100vh; height: 100dvh; 
    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ì ˆëŒ€ ê¸ˆì§€ */
    overflow: hidden; 
    position: fixed; /* ì•„ì´í° ë°”ìš´ìŠ¤ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
    background-color: #fff;
    font-size: 13px; color: #000;
  }
  .hidden { display: none !important; }

  /* ===== Login Screen ===== */
  #view-login {
    width: 100%; height: 100%;
    background-color: #fef01b;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: absolute; z-index: 9999; top: 0; left: 0;
  }
  .login-logo { font-size: 80px; margin-bottom: 40px; color: #3b1e1e; }
  .login-form { width: 80%; max-width: 280px; display: flex; flex-direction: column; gap: 10px; }
  .login-input {
    padding: 14px 20px; border: 1px solid #ddd; 
    border-radius: 25px;
    font-size: 14px; outline: none; background: #fff;
  }
  .login-btn {
    padding: 14px; background: #3b1e1e; color: #fff;
    border: none; border-radius: 50px;
    font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px;
    height: 48px; display: flex; align-items: center; justify-content: center;
  }
  .login-error { color: #d93025; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
  .loader {
    width: 20px; height: 20px;
    border: 3px solid #fff; border-bottom-color: transparent;
    border-radius: 50%; animation: rotation 1s linear infinite;
  }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* ===== Main App ===== */
  #screen-container { 
    width: 100%; height: 100%; 
    position: relative; 
    overflow: hidden; /* ë‚´ë¶€ ìš”ì†Œê°€ ê°€ë¡œë¡œ ì‚ì ¸ë‚˜ì˜¤ì§€ ì•Šê²Œ í•¨ */
    display: none; 
  }
  
  .home-header { height: 52px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 20px; font-weight: 700; }
  .header-icons { display: flex; gap: 18px; }
  .icon { font-family: 'Material Symbols Outlined'; font-size: 26px; font-weight: 300; cursor: pointer; }
  
  .tab-content { 
    width: 100%;
    height: calc(100% - 52px - 58px); /* í—¤ë”ì™€ ë„¤ë¹„ ì œì™¸ ì˜ì—­ */
    overflow-y: auto; 
    overflow-x: hidden; /* íƒ­ ë‚´ë¶€ì—ì„œë„ ê°€ë¡œìŠ¤í¬ë¡¤ ì°¨ë‹¨ */
    padding-bottom: env(safe-area-inset-bottom);
    /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë§Œ í—ˆìš©í•˜ë„ë¡ í„°ì¹˜ ì œì–´ */
    touch-action: pan-y; 
  }

  .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; }
  .profile-thumb {
    width: 44px; height: 44px; border-radius: 18px;
    background-color: #eee; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600; color: rgba(0,0,0,0.5); font-size: 14px;
    margin-right: 12px;
  }
  .list-item .text-area { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .list-item .name { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
  .list-item .desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .badge-p { background: #ffeb3b; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }
  .badge-g { background: #ddd; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }

  /* More Tab */
  .more-menu { padding: 20px 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
  .menu-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
  .menu-icon { font-size: 30px; color: #444; background: #f2f2f2; padding: 12px; border-radius: 50%; }
  .menu-text { font-size: 12px; }
  .my-info-card { display: flex; align-items: center; padding: 20px 16px; }

  /* Bottom Nav */
  .bottom-nav { 
    height: calc(58px + env(safe-area-inset-bottom)); 
    border-top: 1px solid #f1f1f1; 
    display: flex; 
    align-items: flex-start; 
    justify-content: space-around; 
    background: #fff; 
    padding-top: 10px;
    padding-bottom: env(safe-area-inset-bottom); 
    position: absolute; 
    bottom: 0; 
    width: 100%; 
    z-index: 100;
  }
  .nav-item { display: flex; flex-direction: column; align-items: center; color: #bbb; cursor: pointer; width: 100%; }
  .nav-item.active { color: #333; }
  
  /* Chat Room - ìŠ¤í¬ë¡¤ì— ê±¸ë¦¬ì§€ ì•Šë„ë¡ ê³ ì • */
  #view-chat {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #b2c7d9; z-index: 200;
    display: flex; flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    visibility: hidden; /* ë‹«í˜€ìˆì„ ë•Œ ë¸Œë¼ìš°ì €ê°€ ì¸ì‹í•˜ì§€ ëª»í•˜ê²Œ í•¨ */
  }
  #view-chat.open { transform: translateX(0); visibility: visible; }
  .chat-header { height: 50px; background: rgba(255,255,255,0.95); display: flex; align-items: center; padding: 0 10px; }
  .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; touch-action: pan-y; }
  .msg-row { display: flex; width: 100%; }
  .msg-row.me { justify-content: flex-end; }
  .bubble { padding: 8px 12px; font-size: 14px; border-radius: 12px; max-width: 70%; word-break: break-all; }
  .other .bubble { background: #fff; border-top-left-radius: 2px; }
  .me .bubble { background: #fef01b; border-top-right-radius: 2px; }
  
  #input-area { 
    background: #fff; 
    padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px; 
    display: flex; gap: 10px; align-items: center; 
  }
  #msg-input { flex: 1; height: 38px; background: #f5f5f5; border: none; border-radius: 20px; padding: 0 16px; outline: none; }
  #send-btn { width: 38px; height: 38px; background: #fef01b; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; }

  /* Modal */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; }
  .modal-box { background: #fff; width: 80%; max-width: 300px; padding: 20px; border-radius: 16px; text-align: center; }
  .modal-btn { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
  .bg-y { background: #fef01b; color: #3b1e1e; }
  .bg-g { background: #f2f2f2; color: #333; }
</style>
</head>
<body>

<div id="view-login">
  <span class="material-symbols-outlined login-logo">chat_bubble</span>
  <div class="login-form">
    <input id="login-id" class="login-input" placeholder="ì•„ì´ë””" autocomplete="off">
    <input id="login-pw" type="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="login-btn" onclick="handleLogin()">
      <span id="btn-text">ë¡œê·¸ì¸</span>
      <span id="btn-loader" class="loader hidden"></span>
    </button>
    <div id="login-msg" class="login-error"></div>
  </div>
</div>

<div id="screen-container">
  <div id="view-home" style="width:100%; height:100%; display:flex; flex-direction:column;">
    <div class="home-header">
      <span id="header-title">ì¹œêµ¬</span>
      <div class="header-icons">
        <span class="icon" onclick="openCreateChatModal()">add_circle</span>
        <span class="icon">search</span>
      </div>
    </div>

    <div id="tab-friends" class="tab-content">
      <div class="my-info-card">
        <div class="profile-thumb" id="my-profile-img">ë‚˜</div>
        <div class="text-area" style="margin-left:12px;">
          <div class="name" id="my-name-display" style="font-size:16px;">ë‚˜</div>
          <div class="desc" id="my-status-display">ìƒíƒœë©”ì‹œì§€ ì…ë ¥ í•„ìš”</div>
        </div>
      </div>
      <hr style="border:0; border-top:1px solid #f5f5f5; margin:0 0 10px 0;">
      <div id="friends-list-container"></div>
    </div>

    <div id="tab-chats" class="tab-content hidden">
      <div id="chat-list-container"></div>
    </div>

    <div id="tab-more" class="tab-content hidden">
      <div class="my-info-card">
        <div class="text-area">
          <div class="name" style="font-size:18px; margin-bottom:5px;">ë”ë³´ê¸°</div>
          <div class="desc" id="more-email-display">user@email.com</div>
        </div>
      </div>
      
      <div class="status-editor" id="status-edit-area" style="padding: 0 16px; display: none;">
        <input id="new-status-input" class="login-input" style="width:100%; border-radius:8px; margin-bottom:8px;" placeholder="ìƒˆ ìƒíƒœë©”ì‹œì§€ ì…ë ¥">
        <div style="display:flex; gap:8px;">
          <button class="modal-btn bg-y" style="margin:0;" onclick="saveStatus()">ì €ì¥</button>
          <button class="modal-btn bg-g" style="margin:0;" onclick="toggleStatusEditor()">ì·¨ì†Œ</button>
        </div>
      </div>

      <div class="more-menu">
        <div class="menu-btn" onclick="toggleStatusEditor()">
          <span class="material-symbols-outlined menu-icon">edit_note</span>
          <span class="menu-text">ìƒíƒœë³€ê²½</span>
        </div>
        <div class="menu-btn" onclick="clearRoomHistory()">
          <span class="material-symbols-outlined menu-icon">delete_sweep</span>
          <span class="menu-text">ê¸°ë¡ì‚­ì œ</span>
        </div>
        <div class="menu-btn" onclick="exportChat()">
          <span class="material-symbols-outlined menu-icon">download</span>
          <span class="menu-text">ë‚´ë³´ë‚´ê¸°</span>
        </div>
        <div class="menu-btn" onclick="importChat()">
          <span class="material-symbols-outlined menu-icon">upload</span>
          <span class="menu-text">ê°€ì ¸ì˜¤ê¸°</span>
        </div>
        <div class="menu-btn" onclick="logout()">
          <span class="material-symbols-outlined menu-icon" style="color:#d93025; background:#ffebeb;">logout</span>
          <span class="menu-text" style="color:#d93025;">ë¡œê·¸ì•„ì›ƒ</span>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <div class="nav-item active" onclick="switchTab('friends', this)">
        <span class="material-symbols-outlined" style="font-size:26px;">person</span>
      </div>
      <div class="nav-item" onclick="switchTab('chats', this)">
        <span class="material-symbols-outlined" style="font-size:24px;">chat_bubble</span>
      </div>
      <div class="nav-item" onclick="switchTab('more', this)">
        <span class="material-symbols-outlined" style="font-size:28px;">more_horiz</span>
      </div>
    </div>
  </div>

  <div id="view-chat">
    <header class="chat-header">
      <span class="material-symbols-outlined" style="font-size:24px; padding:10px; cursor:pointer;" onclick="exitRoom()">arrow_back</span>
      <div style="flex:1; font-weight:700; font-size:16px;" id="room-title">ì±„íŒ…ë°©</div>
    </header>
    <div id="chat-msgs" class="chat-msgs"></div>
    <div id="input-area">
      <span class="material-symbols-outlined" style="color:#bbb;">add</span>
      <input id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥">
      <button id="send-btn" onclick="sendMsg()">
        <span class="material-symbols-outlined" style="font-size:20px;">arrow_upward</span>
      </button>
    </div>
  </div>
</div>

<div id="createChatModal" class="modal">
  <div class="modal-box">
    <h3>ìƒˆë¡œìš´ ì±„íŒ…</h3>
    <input id="new-room-name" class="login-input" style="width:100%; margin-top:10px; border-radius:10px;" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ê°€ì¡±ë°©)">
    <button class="modal-btn bg-y" onclick="createGroupChat()">ë§Œë“¤ê¸°</button>
    <button class="modal-btn bg-g" onclick="closeModal('createChatModal')">ì·¨ì†Œ</button>
  </div>
</div>

<input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport(this)">

<script>
  /* ===== Global State ===== */
  const API_URL = "https://jaewondev3.pythonanywhere.com";
  let myId = localStorage.getItem("myId");
  let myName = localStorage.getItem("myName");
  let myStatus = localStorage.getItem("myStatus") || "";
  let friendList = JSON.parse(localStorage.getItem("friendList") || "[]");
  let myChatRooms = JSON.parse(localStorage.getItem("myChatRooms") || "[]");
  let currentRoomId = null;
  let chatPollInterval = null;

  const pastelColors = ["#FFB7B2", "#FFDAC1", "#E2F0CB", "#B5EAD7", "#C7CEEA", "#e4c1f9"];
  function getColor(s) { return pastelColors[s.length % pastelColors.length]; }

  if (myId) initApp();

  async function handleLogin() {
    const id = document.getElementById("login-id").value;
    const pw = document.getElementById("login-pw").value;
    const btnText = document.getElementById("btn-text");
    const loader = document.getElementById("btn-loader");
    const msgBox = document.getElementById("login-msg");
    btnText.classList.add("hidden");
    loader.classList.remove("hidden");
    msgBox.style.display = "none";
    try {
      const res = await fetch(API_URL + "/login", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id, password:pw})
      });
      const data = await res.json();
      if(data.success) {
        myId = data.id; myName = data.name; myStatus = data.status; friendList = data.friendList;
        localStorage.setItem("myId", myId);
        localStorage.setItem("myName", myName);
        localStorage.setItem("myStatus", myStatus);
        localStorage.setItem("friendList", JSON.stringify(friendList));
        initApp();
      } else { throw new Error(data.message); }
    } catch(err) {
      msgBox.innerText = err.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨";
      msgBox.style.display = "block";
      btnText.classList.remove("hidden");
      loader.classList.add("hidden");
    }
  }

  function initApp() {
    document.getElementById("view-login").style.display = "none";
    document.getElementById("screen-container").style.display = "block";
    updateMyInfoUI();
    renderFriends();
    renderChatList();
  }

  function updateMyInfoUI() {
    document.getElementById("my-name-display").innerText = myName;
    document.getElementById("my-status-display").innerText = myStatus || "ìƒíƒœë©”ì‹œì§€ ì—†ìŒ";
    document.getElementById("my-profile-img").style.backgroundColor = getColor(myName);
    document.getElementById("more-email-display").innerText = myId + "@mintalk.kro.kr";
  }

  function logout() { localStorage.clear(); location.reload(); }

  function switchTab(tab, el) {
    document.querySelectorAll(".nav-item").forEach(e => e.classList.remove("active"));
    el.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(e => e.classList.add("hidden"));
    document.getElementById(`tab-${tab}`).classList.remove("hidden");
    const titles = { friends: "ì¹œêµ¬", chats: "ì±„íŒ…", more: "ë”ë³´ê¸°" };
    document.getElementById("header-title").innerText = titles[tab];
    if(tab === 'chats') renderChatList();
  }

  function enterRoom(id, title, type) {
    const exists = myChatRooms.find(r => r.id === id);
    if (!exists) {
      myChatRooms.unshift({ id, title, type, lastMsg: "ìƒˆ ëŒ€í™” ì‹œì‘" });
      localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    }
    currentRoomId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("view-chat").classList.add("open");
    document.getElementById("chat-msgs").innerHTML = "";
    loadMsgs();
    chatPollInterval = setInterval(loadMsgs, 1000);
  }

  function exitRoom() {
    document.getElementById("view-chat").classList.remove("open");
    clearInterval(chatPollInterval);
    currentRoomId = null;
    renderChatList();
  }

  function startPrivateChat(friendId, friendName) {
    const sorted = [myId, friendId].sort();
    const roomId = `private_${sorted[0]}_${sorted[1]}`;
    enterRoom(roomId, friendName, 'private');
  }

  function createGroupChat() {
    const name = document.getElementById("new-room-name").value.trim();
    if(name) { closeModal('createChatModal'); enterRoom(`group_${name}`, name, 'group'); }
  }

  function renderChatList() {
    const container = document.getElementById("chat-list-container");
    container.innerHTML = "";
    if(myChatRooms.length === 0) {
      container.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>ì§„í–‰ ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    myChatRooms.forEach(room => {
      const isPrivate = room.type === 'private';
      const iconChar = isPrivate ? room.title[0] : 'ğŸ“¢';
      const color = isPrivate ? getColor(room.title) : '#ddd';
      const badge = isPrivate ? `<span class="badge-p">1:1</span>` : `<span class="badge-g">ì˜¤í”ˆ</span>`;
      const div = document.createElement("div");
      div.className = "list-item";
      div.onclick = () => enterRoom(room.id, room.title, room.type);
      div.innerHTML = `
        <div class="profile-thumb" style="background:${color}">${iconChar}</div>
        <div class="text-area">
          <div class="name">${room.title}</div>
          <div class="desc">${badge} ${room.lastMsg || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ'}</div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  async function loadMsgs() {
    if(!currentRoomId) return;
    try {
      const res = await fetch(`${API_URL}/messages?room=${currentRoomId}`);
      const msgs = await res.json();
      renderMsgs(msgs);
    } catch(e) {}
  }

  function renderMsgs(msgs) {
    const box = document.getElementById("chat-msgs");
    box.innerHTML = "";
    msgs.forEach(m => {
      const isMe = m.name === myName;
      const div = document.createElement("div");
      div.className = `msg-row ${isMe ? 'me' : 'other'}`;
      div.innerHTML = `
        <div class="msg-content">
          ${!isMe ? `<span style="font-size:11px; margin-bottom:2px; margin-left:2px; color:#666;">${m.name}</span>` : ''}
          <div class="bubble">${m.msg}</div>
        </div>
      `;
      box.appendChild(div);
    });
    if(msgs.length > 0) {
      const last = msgs[msgs.length-1].msg;
      const roomIdx = myChatRooms.findIndex(r => r.id === currentRoomId);
      if(roomIdx >= 0 && myChatRooms[roomIdx].lastMsg !== last) {
        myChatRooms[roomIdx].lastMsg = last;
        localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
      }
      box.scrollTop = box.scrollHeight;
    }
  }

  async function sendMsg() {
    const input = document.getElementById("msg-input");
    const msg = input.value.trim();
    if(!msg) return;
    await fetch(API_URL + "/send", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId, name: myName, msg: msg })
    });
    input.value = "";
    loadMsgs();
  }
  
  document.getElementById("msg-input").addEventListener("keydown", e=>{ if(e.key==="Enter") sendMsg(); });

  function toggleStatusEditor() {
    const el = document.getElementById("status-edit-area");
    el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
  }
  
  async function saveStatus() {
    const newStat = document.getElementById("new-status-input").value;
    if(!newStat) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    await fetch(API_URL + "/update-status", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id: myId, status: newStat})
    });
    myStatus = newStat;
    localStorage.setItem("myStatus", newStat);
    updateMyInfoUI();
    toggleStatusEditor();
    alert("ìƒíƒœë©”ì‹œì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  function clearRoomHistory() {
    if(confirm("ëª¨ë“  ì±„íŒ…ë°© ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      myChatRooms = []; localStorage.setItem("myChatRooms", "[]"); renderChatList();
    }
  }

  function exportChat() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myChatRooms));
    const node = document.createElement("a");
    node.setAttribute("href", dataStr); node.setAttribute("download", "chat_backup.json");
    document.body.appendChild(node); node.click(); node.remove();
  }

  function importChat() { document.getElementById("file-input").click(); }

  function handleFileImport(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const imported = JSON.parse(e.target.result);
        myChatRooms = imported;
        localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
        alert("ë³µì› ì™„ë£Œ!"); renderChatList();
      } catch(err) { alert("ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤."); }
    };
    reader.readAsText(file);
    input.value = "";
  }

  function renderFriends() {
    const c = document.getElementById("friends-list-container");
    c.innerHTML = "";
    friendList.forEach(f => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.onclick = () => startPrivateChat(f.id, f.name);
      div.innerHTML = `
        <div class="profile-thumb" style="background:${getColor(f.name)}">${f.name[0]}</div>
        <div class="text-area">
          <div class="name">${f.name}</div>
          <div class="desc">${f.status || 'ìƒíƒœë©”ì‹œì§€ ì—†ìŒ'}</div>
        </div>
      `;
      c.appendChild(div);
    });
  }
  function openCreateChatModal() { document.getElementById("createChatModal").style.display = "flex"; }
  function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
