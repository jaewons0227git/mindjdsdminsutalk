<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>mintalk</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

<style>
  /* ===== ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì‹ ê·œ ìŠ¤íƒ€ì¼ ì¶”ê°€ ===== */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
  html, body { margin: 0; padding: 0; width: 100%; height: 100vh; height: 100dvh; overflow: hidden; position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; background-color: #fff; font-size: 13px; color: #000; }
  .hidden { display: none !important; }

  /* ë¡œê·¸ì¸ ë“± ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
  #view-login { width: 100%; height: 100%; background-color: #fef01b; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; z-index: 9999; top: 0; left: 0; }
  .login-logo { font-size: 80px; margin-bottom: 40px; color: #3b1e1e; }
  .login-form { width: 80%; max-width: 280px; display: flex; flex-direction: column; gap: 10px; }
  .login-input { padding: 14px 20px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; background: #fff; }
  .login-btn { padding: 14px; background: #3b1e1e; color: #fff; border: none; border-radius: 50px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; height: 48px; display: flex; align-items: center; justify-content: center; }
  .login-error { color: #d93025; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
  .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
  @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #screen-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: none; }
  #main-layout { display: flex; width: 100%; height: 100%; }
  #left-side { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; border-right: 1px solid #eee; }
  
  .home-header { height: 52px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; font-size: 20px; font-weight: 700; }
  .header-icons { display: flex; gap: 18px; }
  .icon { font-family: 'Material Symbols Outlined'; font-size: 26px; font-weight: 300; cursor: pointer; }
  
  .tab-content { width: 100%; height: calc(100% - 52px - 58px); overflow-y: auto; overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom); touch-action: pan-y; }
  .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; position: relative; }
  
  /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ìˆ˜ì •: background-image ì§€ì› */
  .profile-thumb { width: 44px; height: 44px; border-radius: 16px; background-color: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; color: rgba(0,0,0,0.5); font-size: 14px; margin-right: 12px; background-size: cover; background-position: center; border: 1px solid rgba(0,0,0,0.05); }
  
  .list-item .text-area { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
  .list-item .name { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
  .list-item .desc { font-size: 12px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .unread-badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: #ff5252; color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: bold; }
  .badge-p { background: #ffeb3b; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }
  .badge-g { background: #ddd; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; font-weight: bold; }

  .more-menu { padding: 20px 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
  .menu-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
  .menu-icon { font-size: 30px; color: #444; background: #f2f2f2; padding: 12px; border-radius: 50%; }
  .menu-text { font-size: 12px; }
  .my-info-card { display: flex; align-items: center; padding: 20px 16px; }

  .bottom-nav { height: calc(58px + env(safe-area-inset-bottom)); border-top: 1px solid #f1f1f1; display: flex; align-items: flex-start; justify-content: space-around; background: #fff; padding-top: 10px; padding-bottom: env(safe-area-inset-bottom); position: absolute; bottom: 0; width: 100%; z-index: 100; }
  .nav-item { display: flex; flex-direction: column; align-items: center; color: #bbb; cursor: pointer; width: 100%; }
  .nav-item.active { color: #333; }
  
  /* ì±„íŒ…ì°½ */
  #view-chat { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #b2c7d9; z-index: 200; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); visibility: hidden; }
  #view-chat.open { transform: translateX(0); visibility: visible; }
  
  #pc-placeholder { flex: 1; background: #f9f9f9; display: none; flex-direction: column; align-items: center; justify-content: center; color: #ccc; }
  #pc-placeholder .material-symbols-outlined { font-size: 64px; margin-bottom: 10px; }

  .chat-header { height: 50px; background: rgba(255,255,255,0.95); display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; touch-action: pan-y; }
  
  /* ì±„íŒ… ë©”ì‹œì§€ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
  .msg-row { display: flex; width: 100%; flex-shrink: 0; position: relative; }
  .msg-row.me { justify-content: flex-end; }
  .msg-row.other { justify-content: flex-start; align-items: flex-start; }

  /* ì±„íŒ…ë°© í”„ë¡œí•„ ì‚¬ì§„ */
  .chat-profile-img { width: 36px; height: 36px; border-radius: 14px; margin-right: 8px; background-color: #eee; background-size: cover; background-position: center; flex-shrink: 0; cursor: pointer; display: none; }
  .msg-row.other .chat-profile-img { display: block; }

  .msg-content { display: flex; flex-direction: column; max-width: 75%; }
  .me .msg-content { align-items: flex-end; }
  .other .msg-content { align-items: flex-start; }

  /* ë§í’ì„  ìŠ¤íƒ€ì¼ ë° ë§í¬ ìŠ¤íƒ€ì¼ */
  .bubble { padding: 8px 12px; font-size: 14px; border-radius: 12px; word-break: break-all; white-space: pre-wrap; width: fit-content; line-height: 1.4; position: relative; text-align: left; }
  .other .bubble { background: #fff; border-top-left-radius: 2px; color: #000; }
  .me .bubble { background: #fef01b; border-top-right-radius: 2px; color: #000; cursor: pointer; }
  
  /* ë§í¬ ìŠ¤íƒ€ì¼ ì§€ì • */
  .bubble a { color: #007bff; text-decoration: none; cursor: pointer; }
  .bubble a:hover { text-decoration: underline; }

  /* ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ */
  .link-preview { display: block; margin-top: 8px; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); max-width: 240px; text-decoration: none; color: inherit !important; cursor: pointer; }
  .link-preview img { width: 100%; height: 120px; object-fit: cover; display: block; }
  .preview-txt { padding: 10px; }
  .preview-title { font-weight: bold; font-size: 13px; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #000; }
  .preview-desc { font-size: 11px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  /* ì½ìŒ í™•ì¸ ìˆ«ì */
  .read-container { display: flex; align-items: flex-end; }
  .me .read-container { flex-direction: row-reverse; }
  .read-count { font-size: 10px; color: #fef01b; margin: 0 4px; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.1); }
  /* ë…¸ë€ ë§í’ì„  ì˜†ì€ ê¸€ì”¨ê°€ ì•ˆë³´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ìƒ‰ ì¡°ì • */
  .me .read-count { color: #555; } 
  .msg-time { font-size: 9px; color: #555; margin: 0 4px; min-width: max-content; }

  .img-msg { max-width: 200px; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
  .edit-tag { font-size: 9px; color: rgba(0,0,0,0.4); margin-top: 2px; }

  #input-area { background: #fff; padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px; display: flex; gap: 10px; align-items: center; }
  #msg-input { flex: 1; height: 38px; background: #f5f5f5; border: none; border-radius: 20px; padding: 0 16px; outline: none; }
  
  #send-btn { width: 38px; height: 38px; background: #fef01b; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
  #send-btn:disabled { cursor: default; background: #eee; }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: center; justify-content: center; }
  .modal-box { background: #fff; width: 80%; max-width: 300px; padding: 20px; border-radius: 16px; text-align: center; }
  .modal-btn { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
  .bg-y { background: #fef01b; color: #3b1e1e; }
  .bg-g { background: #f2f2f2; color: #333; }
  .bg-r { background: #ff5252; color: #fff; }

  .friend-select-list { max-height: 150px; overflow-y: auto; text-align: left; margin: 10px 0; border: 1px solid #eee; padding: 5px; }
  .friend-select-item { display: flex; align-items: center; gap: 10px; padding: 5px; }

  /* PC ë¯¸ë””ì–´ ì¿¼ë¦¬ */
  @media (min-width: 768px) {
    #left-side { width: 380px; flex-shrink: 0; }
    #view-chat { position: relative; transform: none; visibility: visible; display: none; z-index: 10; flex: 1; border-left: 1px solid #ddd; }
    #view-chat.open { display: flex; }
    #pc-placeholder { display: flex; }
    #view-chat.open ~ #pc-placeholder { display: none; }
    .chat-header .material-symbols-outlined[onclick="exitRoom()"] { display: none; }
  }
</style>
</head>
<body>

<div id="view-login">
  <span class="material-symbols-outlined login-logo">chat_bubble</span>
  <div class="login-form">
    <input id="login-id" class="login-input" placeholder="ì•„ì´ë””" autocomplete="off">
    <input id="login-pw" type="password" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="login-btn" onclick="handleLogin()">
      <span id="btn-text">ë¡œê·¸ì¸</span>
      <span id="btn-loader" class="loader hidden"></span>
    </button>
    <div id="login-msg" class="login-error"></div>
  </div>
</div>

<div id="screen-container">
  <div id="main-layout">
    <div id="left-side">
      <div id="view-home" style="width:100%; height:100%; display:flex; flex-direction:column;">
        <div class="home-header">
          <span id="header-title">ì¹œêµ¬</span>
          <div class="header-icons">
            <span class="icon" onclick="openCreateChatModal()">add_circle</span>
            <span class="icon">search</span>
          </div>
        </div>

        <div id="tab-friends" class="tab-content">
          <div class="my-info-card">
            <div class="profile-thumb" id="my-profile-img">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" id="my-name-display" style="font-size:16px;">ë‚˜</div>
              <div class="desc" id="my-status-display">ìƒíƒœë©”ì‹œì§€ ì…ë ¥ í•„ìš”</div>
            </div>
          </div>
          <hr style="border:0; border-top:1px solid #f5f5f5; margin:0 0 10px 0;">
          <div id="friends-list-container"></div>
        </div>

        <div id="tab-chats" class="tab-content hidden">
          <div id="chat-list-container"></div>
        </div>

        <div id="tab-more" class="tab-content hidden">
          <div class="my-info-card">
            <div class="profile-thumb" id="more-profile-img" style="cursor:pointer;" onclick="openProfileEdit()">ë‚˜</div>
            <div class="text-area" style="margin-left:12px;">
              <div class="name" style="font-size:18px; margin-bottom:5px;">ë”ë³´ê¸°</div>
              <div class="desc" id="more-email-display">user@email.com</div>
              <div class="desc" style="font-size:11px; color:#aaa; margin-top:2px;">ì‚¬ì§„ì„ ëˆŒëŸ¬ í”„ë¡œí•„ ë³€ê²½</div>
            </div>
          </div>
          <div class="status-editor" id="status-edit-area" style="padding: 0 16px; display: none;">
            <input id="new-status-input" class="login-input" style="width:100%; border-radius:8px; margin-bottom:8px;" placeholder="ìƒˆ ìƒíƒœë©”ì‹œì§€ ì…ë ¥">
            <div style="display:flex; gap:8px;">
              <button class="modal-btn bg-y" style="margin:0;" onclick="saveStatus()">ì €ì¥</button>
              <button class="modal-btn bg-g" style="margin:0;" onclick="toggleStatusEditor()">ì·¨ì†Œ</button>
            </div>
          </div>
          <div class="more-menu">
            <div class="menu-btn" onclick="toggleStatusEditor()"><span class="material-symbols-outlined menu-icon">edit_note</span><span class="menu-text">ìƒíƒœë³€ê²½</span></div>
            <div class="menu-btn" onclick="clearRoomHistory()"><span class="material-symbols-outlined menu-icon">delete_sweep</span><span class="menu-text">ê¸°ë¡ì‚­ì œ</span></div>
            <div class="menu-btn" onclick="exportChat()"><span class="material-symbols-outlined menu-icon">download</span><span class="menu-text">ë‚´ë³´ë‚´ê¸°</span></div>
            <div class="menu-btn" onclick="importChat()"><span class="material-symbols-outlined menu-icon">upload</span><span class="menu-text">ê°€ì ¸ì˜¤ê¸°</span></div>
            <div class="menu-btn" onclick="logout()"><span class="material-symbols-outlined menu-icon" style="color:#d93025; background:#ffebeb;">logout</span><span class="menu-text" style="color:#d93025;">ë¡œê·¸ì•„ì›ƒ</span></div>
          </div>
        </div>

        <div class="bottom-nav">
          <div class="nav-item active" onclick="switchTab('friends', this)"><span class="material-symbols-outlined" style="font-size:26px;">person</span></div>
          <div class="nav-item" onclick="switchTab('chats', this)"><span class="material-symbols-outlined" style="font-size:24px;">chat_bubble</span></div>
          <div class="nav-item" onclick="switchTab('more', this)"><span class="material-symbols-outlined" style="font-size:28px;">more_horiz</span></div>
        </div>
      </div>
    </div>

    <div id="view-chat">
      <header class="chat-header">
        <span class="material-symbols-outlined" style="font-size:24px; padding:10px; cursor:pointer;" onclick="exitRoom()">arrow_back</span>
        <div style="flex:1; font-weight:700; font-size:16px;" id="room-title">ì±„íŒ…ë°©</div>
        <span class="material-symbols-outlined" style="cursor:pointer; padding:10px;" onclick="openChatMenu()">menu</span>
      </header>
      <div id="chat-msgs" class="chat-msgs"></div>
      <div id="input-area">
        <input type="file" id="img-input" class="hidden" accept="image/*" onchange="sendImage(this)">
        <span class="material-symbols-outlined" style="color:#bbb; cursor:pointer;" onclick="document.getElementById('img-input').click()">add</span>
        <input id="msg-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" autocomplete="off">
        <button id="send-btn" onclick="sendMsg()">
          <span id="send-icon" class="material-symbols-outlined" style="font-size:20px;">arrow_upward</span>
          <span id="send-loader" class="loader hidden" style="border-color:#333; border-bottom-color:transparent; width:16px; height:16px; border-width:2px;"></span>
        </button>
      </div>
    </div>

    <div id="pc-placeholder">
      <span class="material-symbols-outlined">chat_bubble</span>
      <p>ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
    </div>
  </div>
</div>

<div id="createChatModal" class="modal">
  <div class="modal-box">
    <h3>ìƒˆë¡œìš´ ì±„íŒ…</h3>
    <input id="new-room-name" class="login-input" style="width:100%; margin-top:10px; border-radius:10px;" placeholder="ë°© ì´ë¦„ (ì˜ˆ: ê°€ì¡±ë°©)">
    <div class="friend-select-list" id="friend-select-container"></div>
    <button class="modal-btn bg-y" onclick="createGroupChat()">ë§Œë“¤ê¸°</button>
    <button class="modal-btn bg-g" onclick="closeModal('createChatModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="chatMenuModal" class="modal">
  <div class="modal-box">
    <h3 id="menu-room-name">ì±„íŒ…ë°© ì„¤ì •</h3>
    <button class="modal-btn bg-g" onclick="leaveRoomLocal()">ì±„íŒ…ë°© ë‚˜ê°€ê¸° (ë‚˜ë§Œ)</button>
    <button class="modal-btn bg-r" id="del-room-btn" onclick="deleteRoomGlobal()">ì±„íŒ…ë°© ì‚­ì œ (ëª¨ë‘ì—ê²Œì„œ)</button>
    <button class="modal-btn bg-g" onclick="closeModal('chatMenuModal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="msgMenuModal" class="modal">
  <div class="modal-box">
    <button id="edit-btn-modal" class="modal-btn bg-y" onclick="promptEditMsg()">ìˆ˜ì •</button>
    <button class="modal-btn bg-r" onclick="deleteMsgServer()">ì‚­ì œ</button>
    <button class="modal-btn bg-g" onclick="closeModal('msgMenuModal')">ì·¨ì†Œ</button>
  </div>
</div>

<div id="profileEditModal" class="modal">
  <div class="modal-box">
    <h3>í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</h3>
    <div id="profile-edit-preview" style="width:100px; height:100px; border-radius:30px; background:#eee; margin:20px auto; background-size:cover; background-position:center;"></div>
    <button class="modal-btn bg-y" onclick="document.getElementById('profile-file-input').click()">ì‚¬ì§„ ì„ íƒ</button>
    <button class="modal-btn bg-g" onclick="deleteProfileImage()">ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½</button>
    <button class="modal-btn bg-g" style="margin-top:15px; border-top:1px solid #eee;" onclick="closeModal('profileEditModal')">ë‹«ê¸°</button>
  </div>
</div>

<input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileImport(this)">
<input type="file" id="profile-file-input" class="hidden" accept="image/*" onchange="handleProfileUpload(this)">

<script>
  // API URL ì„¤ì • (ë³¸ì¸ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
  const API_URL = "https://jaewondev3.pythonanywhere.com";
  
  let myId = localStorage.getItem("myId");
  let myName = localStorage.getItem("myName");
  let myStatus = localStorage.getItem("myStatus") || "";
  let myProfileImg = localStorage.getItem("myProfileImg") || ""; // ë‚´ í”„ì‚¬
  let friendList = JSON.parse(localStorage.getItem("friendList") || "[]");
  let myChatRooms = JSON.parse(localStorage.getItem("myChatRooms") || "[]");
  let currentRoomId = null;
  let chatPollInterval = null;
  let listPollInterval = null;
  let selectedMsgId = null;

  const pastelColors = ["#FFB7B2", "#FFDAC1", "#E2F0CB", "#B5EAD7", "#C7CEEA", "#e4c1f9"];
  function getColor(s) { return pastelColors[(s || "").length % pastelColors.length]; }

  if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
    Notification.requestPermission();
  }

  if (myId) initApp();

  async function handleLogin() {
    const id = document.getElementById("login-id").value;
    const pw = document.getElementById("login-pw").value;
    const btnText = document.getElementById("btn-text");
    const loader = document.getElementById("btn-loader");
    const msgBox = document.getElementById("login-msg");
    btnText.classList.add("hidden"); loader.classList.remove("hidden"); msgBox.style.display = "none";
    try {
      const res = await fetch(API_URL + "/login", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({id, password:pw})
      });
      const data = await res.json();
      if(data.success) {
        myId = data.id; myName = data.name; myStatus = data.status; 
        friendList = data.friendList;
        myProfileImg = data.profile_img || "";

        localStorage.setItem("myId", myId); localStorage.setItem("myName", myName);
        localStorage.setItem("myStatus", myStatus); 
        localStorage.setItem("friendList", JSON.stringify(friendList));
        localStorage.setItem("myProfileImg", myProfileImg);

        if ("Notification" in window) Notification.requestPermission();
        initApp();
      } else { throw new Error(data.message); }
    } catch(err) {
      msgBox.innerText = err.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨"; msgBox.style.display = "block";
      btnText.classList.remove("hidden"); loader.classList.add("hidden");
    }
  }

  function initApp() {
    document.getElementById("view-login").style.display = "none";
    document.getElementById("screen-container").style.display = "block";
    updateMyInfoUI(); renderFriends(); renderChatList();
    listPollInterval = setInterval(syncRoomsFromServer, 2000);
  }

  function sendPushNotification(title, body) {
    if (Notification.permission === "granted") {
      new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png' });
    }
  }

  async function syncRoomsFromServer() {
    try {
      const res = await fetch(`${API_URL}/my-rooms?name=${myName}&id=${myId}`);
      const serverRooms = await res.json();
      let changed = false;
      serverRooms.forEach(sr => {
        const local = myChatRooms.find(r => r.id === sr.id);
        if(!local) {
          let title = sr.id.startsWith('private') ? sr.id.replace('private_','').replace(myId,'').replace('_','') : sr.id.replace('group_','');
          if(sr.id.startsWith('private')) {
            const f = friendList.find(fr => sr.id.includes(fr.id));
            if(f) title = f.name;
          }
          myChatRooms.unshift({ id: sr.id, title, type: sr.id.split('_')[0], lastMsg: sr.lastMsg, lastReadCount: 0, creator: sr.creator, messages_count: sr.messages_count });
          changed = true;
          if(sr.creator !== myName) sendPushNotification("ìƒˆ ì±„íŒ…ë°©", `${title} ë°©ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          if(local.messages_count !== sr.messages_count) {
             if(sr.messages_count > (local.messages_count || 0)) {
               if(currentRoomId !== sr.id || document.hidden) {
                  sendPushNotification(local.title, sr.lastMsg || "ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
               }
            }
            local.messages_count = sr.messages_count;
            local.lastMsg = sr.lastMsg;
            changed = true;
          }
        }
      });
      if(changed) {
        localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
        renderChatList();
      }
    } catch(e) {}
  }

  function setProfileImg(elId, imgData, fallbackName) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (imgData) {
        el.innerText = "";
        el.style.backgroundImage = `url(${imgData})`;
        el.style.backgroundColor = "transparent";
    } else {
        el.style.backgroundImage = "none";
        el.innerText = fallbackName ? fallbackName[0] : "?";
        el.style.backgroundColor = fallbackName ? getColor(fallbackName) : "#eee";
    }
  }

  function updateMyInfoUI() {
    document.getElementById("my-name-display").innerText = myName;
    document.getElementById("my-status-display").innerText = myStatus || "ìƒíƒœë©”ì‹œì§€ ì—†ìŒ";
    document.getElementById("more-email-display").innerText = myId + "@mintalk.kro.kr";
    
    // ë‚´ í”„ë¡œí•„ ì´ë¯¸ì§€ ì ìš©
    setProfileImg("my-profile-img", myProfileImg, myName);
    setProfileImg("more-profile-img", myProfileImg, myName);
  }

  function logout() { localStorage.clear(); location.reload(); }

  function switchTab(tab, el) {
    document.querySelectorAll(".nav-item").forEach(e => e.classList.remove("active"));
    el.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(e => e.classList.add("hidden"));
    document.getElementById(`tab-${tab}`).classList.remove("hidden");
    const titles = { friends: "ì¹œêµ¬", chats: "ì±„íŒ…", more: "ë”ë³´ê¸°" };
    document.getElementById("header-title").innerText = titles[tab];
    if(tab === 'chats') renderChatList();
  }

  function enterRoom(id, title, type) {
    const room = myChatRooms.find(r => r.id === id);
    if (!room) {
      myChatRooms.unshift({ id, title, type, lastMsg: "ìƒˆ ëŒ€í™”", lastReadCount: 0 });
    } else {
      room.lastReadCount = room.messages_count || 0;
    }
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    currentRoomId = id;
    document.getElementById("room-title").innerText = title;
    document.getElementById("view-chat").classList.add("open");
    document.getElementById("chat-msgs").innerHTML = "";
    loadMsgs();
    if(chatPollInterval) clearInterval(chatPollInterval);
    chatPollInterval = setInterval(loadMsgs, 1000);
  }

  function exitRoom() {
    document.getElementById("view-chat").classList.remove("open");
    clearInterval(chatPollInterval);
    currentRoomId = null;
    renderChatList();
  }

  function renderChatList() {
    const container = document.getElementById("chat-list-container");
    container.innerHTML = "";
    if(myChatRooms.length === 0) {
      container.innerHTML = "<div style='padding:20px; text-align:center; color:#999;'>ì§„í–‰ ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    myChatRooms.forEach(room => {
      const isPrivate = room.type === 'private';
      const iconChar = isPrivate ? (room.title ? room.title[0] : '?') : 'ğŸ“¢';
      
      // ì¹œêµ¬ í”„ì‚¬ ì°¾ê¸°
      let roomImg = null;
      if(isPrivate) {
         const friend = friendList.find(f => room.id.includes(f.id));
         if(friend && friend.profile_img) roomImg = friend.profile_img;
      }

      const badge = isPrivate ? `<span class="badge-p">1:1</span>` : `<span class="badge-g">ë‹¨ì²´</span>`;
      const unreadCount = (room.messages_count || 0) - (room.lastReadCount || 0);
      const unreadHtml = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : "";

      const div = document.createElement("div");
      div.className = "list-item";
      div.onclick = () => enterRoom(room.id, room.title, room.type);
      
      let imgHtml = `<div class="profile-thumb" style="background:${getColor(room.title||"")}">${iconChar}</div>`;
      if(roomImg) {
        imgHtml = `<div class="profile-thumb" style="background-image:url(${roomImg}); background-color:transparent;"></div>`;
      }

      div.innerHTML = `
        ${imgHtml}
        <div class="text-area">
          <div class="name">${room.title}</div>
          <div class="desc">${badge} ${room.lastMsg || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ'}</div>
        </div>
        ${unreadHtml}
      `;
      container.appendChild(div);
    });
  }

  async function loadMsgs() {
    if(!currentRoomId) return;
    try {
      const res = await fetch(`${API_URL}/messages?room=${currentRoomId}`);
      const msgs = await res.json();
      
      // ì½ìŒ ì²˜ë¦¬ ìš”ì²­
      await fetch(`${API_URL}/mark-read`, {
          method: "POST", headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ room: currentRoomId, id: myId })
      });

      renderMsgs(msgs);
      const room = myChatRooms.find(r => r.id === currentRoomId);
      if(room) { room.messages_count = msgs.length; room.lastReadCount = msgs.length; }
    } catch(e) {}
  }

  // URLì„ ê°ì§€í•˜ì—¬ <a> íƒœê·¸ë¡œ ë³€í™˜
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
      return `<a href="${url}" target="_blank">${url}</a>`;
    });
  }

  function renderMsgs(msgs) {
    const box = document.getElementById("chat-msgs");
    const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 100;
    
    // í˜„ì¬ DOMê³¼ ë¹„êµí•˜ì—¬ ë³€ê²½ì‚¬í•­ë§Œ ë°˜ì˜í•˜ëŠ” ê²ƒì´ ìµœì„ ì´ë‚˜, ê°„ë‹¨í•˜ê²Œ innerHTML ì´ˆê¸°í™” ìœ ì§€
    box.innerHTML = "";
    
    msgs.forEach(m => {
      const isMe = m.name === myName;
      const div = document.createElement("div");
      div.className = `msg-row ${isMe ? 'me' : 'other'}`;
      
      // ìƒëŒ€ë°© í”„ì‚¬ ì°¾ê¸°
      let senderImg = "";
      if(!isMe) {
          const friend = friendList.find(f => f.name === m.name); // ì´ë¦„ìœ¼ë¡œ ì°¾ê¸° (IDê°€ í™•ì‹¤í•˜ë©´ IDë¡œ)
          if(friend && friend.profile_img) senderImg = `background-image:url(${friend.profile_img}); background-color:transparent;`;
          else senderImg = `background-color:${getColor(m.name)}`;
      }

      // ì½ìŒ ìˆ«ì ê³„ì‚° (ì „ì²´ ì¸ì› - ì½ì€ ì‚¬ëŒ ìˆ˜)
      // ë‹¨ì²´ë°© ì¸ì›ì„ ì •í™•íˆ ì•Œ ìˆ˜ ì—†ìœ¼ë‹ˆ ì—¬ê¸°ì„œëŠ” "ì½ì€ ì‚¬ëŒ ìˆ˜"ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ "ì•ˆì½ìŒ" í‘œì‹œ
      // ìš”ì²­ì‚¬í•­: "ì½ì—ˆëŠ”ì§€ ì•ˆì½ì—ˆëŠ”ì§€ í‘œì‹œ".
      // ê°„ë‹¨íˆ: ì½ì€ ì‚¬ëŒ ìˆ˜(read_by.length)ê°€ 2ëª…(1:1)ì´ë©´ 'ì½ìŒ', ì•„ë‹ˆë©´ '1'
      // ë” ì •í™•íˆ: ë‚˜ì™€ ìƒëŒ€ë°©(2ëª… ê¸°ì¤€)ì¼ ë•Œ, read_byì— ìƒëŒ€ë°©ì´ ì—†ìœ¼ë©´ '1', ìˆìœ¼ë©´ ê³µë°±
      let readCountDisplay = "";
      if (m.read_by) {
          // ë‚´ê°€ ì“´ ê¸€: ìƒëŒ€ë°©ì´ ì½ì—ˆëŠ”ì§€ (read_byì— ë‚˜ ë§ê³  ë‹¤ë¥¸ ì‚¬ëŒì´ ìˆëŠ”ì§€)
          if(isMe) {
             if (m.read_by.length < 2) readCountDisplay = "1"; // ì•„ë¬´ë„ ì•ˆì½ìŒ (ë‚˜ë§Œ ì½ìŒ)
          } else {
             // ë‚¨ì´ ì“´ ê¸€: ë‚´ê°€ ì½ì—ˆëŠ”ì§€ëŠ” ì´ë¯¸ mark-readí–ˆìœ¼ë¯€ë¡œ ì˜ë¯¸ ì—†ê³  UIìƒ ì•ˆë³´ì—¬ë„ ë¨
          }
      }

      // ë³¸ë¬¸ ì²˜ë¦¬ (ë§í¬ ë³€í™˜)
      let contentHtml = "";
      if (m.image) {
          contentHtml = `<img src="${m.image}" class="img-msg" onclick="${isMe ? `openMsgMenu('${m.id}', true)` : ''}">`;
      } else {
          contentHtml = `<div class="bubble" onclick="${isMe ? `openMsgMenu('${m.id}', false)` : ''}">${linkify(m.msg)}</div>`;
      }
      
      // ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ (ë³¸ë¬¸ì— ë§í¬ê°€ ìˆê³ , preview ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
      if(m.preview) {
          contentHtml += `
            <a href="${m.preview.url}" target="_blank" class="link-preview">
                ${m.preview.image ? `<img src="${m.preview.image}">` : ''}
                <div class="preview-txt">
                    <div class="preview-title">${m.preview.title}</div>
                    <div class="preview-desc">${m.preview.description}</div>
                </div>
            </a>
          `;
      }

      if(m.edited) contentHtml += `<span class="edit-tag">ìˆ˜ì •ë¨</span>`;

      // HTML ì¡°ë¦½
      div.innerHTML = `
        ${!isMe ? `<div class="chat-profile-img" style="${senderImg}">${senderImg.includes('url')?'':m.name[0]}</div>` : ''}
        <div class="msg-content">
          ${!isMe ? `<span style="font-size:11px; margin-bottom:4px; margin-left:2px; color:#666;">${m.name}</span>` : ''}
          <div class="read-container">
             ${contentHtml}
             <div style="display:flex; flex-direction:column; justify-content:flex-end;">
                <span class="read-count">${readCountDisplay}</span>
                <span class="msg-time">${m.time}</span>
             </div>
          </div>
        </div>
      `;
      box.appendChild(div);
    });
    if(isAtBottom) box.scrollTop = box.scrollHeight;
  }

  async function sendMsg() {
    const input = document.getElementById("msg-input");
    const btn = document.getElementById("send-btn");
    const icon = document.getElementById("send-icon");
    const loader = document.getElementById("send-loader");
    const msg = input.value.trim();
    if(!msg) return;

    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");

    try {
      await fetch(API_URL + "/send", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ room: currentRoomId, name: myName, msg: msg })
      });
      input.value = ""; 
      loadMsgs();
    } finally {
      btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden");
      input.focus();
    }
  }

  async function sendImage(input) {
    const file = input.files[0];
    const btn = document.getElementById("send-btn");
    const icon = document.getElementById("send-icon");
    const loader = document.getElementById("send-loader");
    if(!file) return;

    btn.disabled = true; icon.classList.add("hidden"); loader.classList.remove("hidden");

    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = async function() {
        const canvas = document.createElement('canvas');
        let width = img.width, height = img.height, max_size = 800;
        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } } 
        else { if (height > max_size) { width *= max_size / height; height = max_size; } }
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        
        try {
          await fetch(API_URL + "/send", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ room: currentRoomId, name: myName, image: compressedBase64, msg: "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤." })
          });
          loadMsgs();
        } finally {
          btn.disabled = false; icon.classList.remove("hidden"); loader.classList.add("hidden");
        }
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = "";
  }

  function openMsgMenu(id, isImage) {
    selectedMsgId = id;
    document.getElementById("edit-btn-modal").style.display = isImage ? "none" : "block";
    document.getElementById("msgMenuModal").style.display = "flex";
  }

  async function deleteMsgServer() {
    if(!confirm("ì´ ë©”ì‹œì§€(ë˜ëŠ” ì‚¬ì§„)ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
    await fetch(API_URL + "/delete-msg", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId })
    });
    closeModal('msgMenuModal'); loadMsgs();
  }

  async function promptEditMsg() {
    const newMsg = prompt("ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if(!newMsg) return;
    await fetch(API_URL + "/edit-msg", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId, msgId: selectedMsgId, msg: newMsg })
    });
    closeModal('msgMenuModal'); loadMsgs();
  }

  function openChatMenu() {
    const room = myChatRooms.find(r => r.id === currentRoomId);
    document.getElementById("menu-room-name").innerText = room.title;
    document.getElementById("del-room-btn").style.display = (room.type === 'group') ? "block" : "none";
    document.getElementById("chatMenuModal").style.display = "flex";
  }

  function leaveRoomLocal() {
    if(!confirm("ë¦¬ìŠ¤íŠ¸ì—ì„œ ì´ ì±„íŒ…ë°©ì„ ì—†ì•¨ê¹Œìš”?")) return;
    myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId);
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    closeModal('chatMenuModal'); exitRoom();
  }

  async function deleteRoomGlobal() {
    if(!confirm("ì´ ì±„íŒ…ë°©ì˜ ëª¨ë“  ëŒ€í™”ë‚´ìš©ì„ ì‚­ì œí•˜ê³  ë°©ì„ ì—†ì•¨ê¹Œìš”?")) return;
    await fetch(API_URL + "/delete-room", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: currentRoomId })
    });
    myChatRooms = myChatRooms.filter(r => r.id !== currentRoomId);
    localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms));
    closeModal('chatMenuModal'); exitRoom();
  }

  function openCreateChatModal() {
    const container = document.getElementById("friend-select-container");
    container.innerHTML = "";
    friendList.forEach(f => {
      container.innerHTML += `
        <div class="friend-select-item">
          <input type="checkbox" name="invited-friend" value="${f.name}" id="chk-${f.id}">
          <label for="chk-${f.id}">${f.name}</label>
        </div>`;
    });
    document.getElementById("createChatModal").style.display = "flex";
  }

  function createGroupChat() {
    const name = document.getElementById("new-room-name").value.trim();
    const checked = document.querySelectorAll('input[name="invited-friend"]:checked');
    if(!name) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
    let participants = [myName];
    checked.forEach(c => participants.push(c.value));
    const roomId = `group_${Date.now()}`;
    enterRoom(roomId, name, 'group');
    fetch(API_URL + "/send", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ room: roomId, name: "System", msg: `${myName}ë‹˜ì´ ë°©ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.`, participants: participants })
    });
    closeModal('createChatModal');
  }

  function startPrivateChat(friendId, friendName) {
    const sorted = [myId, friendId].sort();
    const roomId = `private_${sorted[0]}_${sorted[1]}`;
    enterRoom(roomId, friendName, 'private');
  }

  // --- í”„ë¡œí•„ ì‚¬ì§„ ê´€ë ¨ í•¨ìˆ˜ ---
  function openProfileEdit() {
      setProfileImg("profile-edit-preview", myProfileImg, myName);
      document.getElementById("profileEditModal").style.display = "flex";
  }

  function handleProfileUpload(input) {
    const file = input.files[0];
    if(!file) return;
    
    // ì´ë¯¸ì§€ ì••ì¶• ë° ë¦¬ì‚¬ì´ì§• (ë ‰ ë°©ì§€)
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = async function() {
        const canvas = document.createElement('canvas');
        // í”„ë¡œí•„ìš©ìœ¼ë¡œ 300px ì •ì‚¬ê°í˜• cropì— ê°€ê¹ê²Œ ë¦¬ì‚¬ì´ì§•
        let size = 300;
        let width = img.width, height = img.height;
        
        // ì¤‘ì•™ í¬ë¡­ì„ ìœ„í•œ ê³„ì‚°
        let sx, sy, sWidth, sHeight;
        if(width > height) {
            sHeight = height; sWidth = height; sx = (width - height) / 2; sy = 0;
        } else {
            sWidth = width; sHeight = width; sx = 0; sy = (height - width) / 2;
        }
        
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, size, size);
        
        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
        
        // ì„œë²„ ì „ì†¡
        await fetch(API_URL + "/update-profile-img", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ id: myId, image: compressedBase64 })
        });
        
        myProfileImg = compressedBase64;
        localStorage.setItem("myProfileImg", myProfileImg);
        updateMyInfoUI();
        closeModal("profileEditModal");
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = "";
  }

  async function deleteProfileImage() {
      if(!confirm("ê¸°ë³¸ ì´ë¯¸ì§€ë¡œ ëŒì•„ê°ˆê¹Œìš”?")) return;
      await fetch(API_URL + "/update-profile-img", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ id: myId, image: null })
      });
      myProfileImg = "";
      localStorage.setItem("myProfileImg", "");
      updateMyInfoUI();
      closeModal("profileEditModal");
  }
  // ---------------------------

  document.getElementById("msg-input").addEventListener("keydown", e=>{ if(e.key==="Enter") sendMsg(); });
  function toggleStatusEditor() { const el = document.getElementById("status-edit-area"); el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none"; }
  async function saveStatus() {
    const newStat = document.getElementById("new-status-input").value;
    if(!newStat) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
    await fetch(API_URL + "/update-status", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({id: myId, status: newStat}) });
    myStatus = newStat; localStorage.setItem("myStatus", newStat);
    updateMyInfoUI(); toggleStatusEditor(); alert("ìƒíƒœë©”ì‹œì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  function clearRoomHistory() { if(confirm("ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { myChatRooms = []; localStorage.setItem("myChatRooms", "[]"); renderChatList(); } }
  function exportChat() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myChatRooms)); const node = document.createElement("a"); node.setAttribute("href", dataStr); node.setAttribute("download", "chat_backup.json"); document.body.appendChild(node); node.click(); node.remove(); }
  function importChat() { document.getElementById("file-input").click(); }
  function handleFileImport(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try { const imported = JSON.parse(e.target.result); myChatRooms = imported; localStorage.setItem("myChatRooms", JSON.stringify(myChatRooms)); alert("ë³µì› ì™„ë£Œ!"); renderChatList(); } catch(err) { alert("ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤."); }
    };
    reader.readAsText(file); input.value = "";
  }
  
  function renderFriends() {
    const c = document.getElementById("friends-list-container");
    c.innerHTML = "";
    friendList.forEach(f => {
      const div = document.createElement("div"); div.className = "list-item";
      div.onclick = () => startPrivateChat(f.id, f.name);
      
      let imgHtml = `<div class="profile-thumb" style="background:${getColor(f.name)}">${f.name[0]}</div>`;
      if(f.profile_img) {
          imgHtml = `<div class="profile-thumb" style="background-image:url(${f.profile_img}); background-color:transparent;"></div>`;
      }
      
      div.innerHTML = `
        ${imgHtml}
        <div class="text-area"><div class="name">${f.name}</div><div class="desc">${f.status || 'ìƒíƒœë©”ì‹œì§€ ì—†ìŒ'}</div></div>
      `;
      c.appendChild(div);
    });
  }
  function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>
</body>
</html>
